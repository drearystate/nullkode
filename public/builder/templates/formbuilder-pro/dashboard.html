<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DocuClone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Enhanced Libraries for PDF, Interactions, and Payments -->
    <!-- Load libraries with proper loading checks -->
    <script>
        // Global library loading status
        window.librariesLoaded = {
            interact: false,
            pdfLib: false,
            stripe: false,
            paypal: false,
            signaturePad: false
        };
        
        // Library loading promises
        window.libraryPromises = {};
        
        // Function to load script with promise
        function loadScript(src, globalVar, key) {
            if (window.libraryPromises[key]) {
                return window.libraryPromises[key];
            }
            
            window.libraryPromises[key] = new Promise((resolve, reject) => {
                // First, try to fetch the script to check if it's actually JavaScript
                fetch(src)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(scriptContent => {
                        // Check if the content looks like JavaScript (not HTML error page)
                        if (scriptContent.trim().startsWith('<') || scriptContent.includes('<!DOCTYPE')) {
                            throw new Error(`Received HTML instead of JavaScript from ${src}`);
                        }
                        
                        // Create and load the script element
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = () => {
                            window.librariesLoaded[key] = true;
                            console.log(`‚úÖ ${key} library loaded successfully`);
                            resolve(window[globalVar]);
                        };
                        script.onerror = () => {
                            console.error(`‚ùå Failed to execute ${key} library from ${src}`);
                            reject(new Error(`Failed to execute ${key}`));
                        };
                        document.head.appendChild(script);
                    })
                    .catch(error => {
                        console.error(`‚ùå Failed to load ${key} library from ${src}:`, error);
                        reject(new Error(`Failed to load ${key}: ${error.message}`));
                    });
            });
            
            return window.libraryPromises[key];
        }

        // Enhanced error handling with better feedback
        function handleLibraryError(libraryName, error) {
            console.error(`Library ${libraryName} failed to load:`, error);
            
            // Show user-friendly error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            errorDiv.innerHTML = `
                <strong>Library Loading Issue:</strong> ${libraryName} failed to load from CDN. 
                Using local fallback. Some features may be limited.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 8000);
        }
        
        // Get the correct base path for assets
        const getAssetPath = (filename) => {
            const currentPath = window.location.pathname;
            const basePath = currentPath.includes('/builder/templates/') 
                ? './assets/js/' 
                : '/builder/templates/formbuilder-pro/assets/js/';
            console.log(`üîç Loading ${filename} from: ${basePath + filename}`);
            return basePath + filename;
        };

        // Load all required libraries with real functionality
        const interactPromise = loadScript('https://cdn.jsdelivr.net/npm/interactjs@1.10.19/dist/interact.min.js', 'interact', 'interact')
            .catch((error) => {
                handleLibraryError('Interact.js', error);
                return loadScript(getAssetPath('interact-simulation.js'), 'interact', 'interact');
            });
        // Load local scripts with immediate fallback to embedded versions
        const pdfLibPromise = loadScript(getAssetPath('pdf-generator.js'), 'pdfGenerator', 'pdfLib')
            .catch(() => loadEmbeddedPDFGenerator());
        const configPromise = loadScript(getAssetPath('config-manager.js'), 'configManager', 'config')
            .catch(() => loadEmbeddedConfigManager());
        const paymentPromise = loadScript(getAssetPath('payment-processor.js'), 'paymentProcessor', 'payment')
            .catch(() => loadEmbeddedPaymentProcessor());
        const emailPromise = loadScript(getAssetPath('email-service.js'), 'emailService', 'email')
            .catch(() => loadEmbeddedEmailService());
        const signaturePadPromise = loadScript('https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js', 'SignaturePad', 'SignaturePad')
            .catch((error) => {
                handleLibraryError('Signature Pad', error);
                return loadScript(getAssetPath('signature-pad.min.js'), 'SignaturePad', 'SignaturePad');
            });
        
        // PayPal SDK using local simulation (already loaded in payment-simulation.js)
        window.loadPayPalSDK = function(clientId) {
            if (window.libraryPromises.paypal) {
                return window.libraryPromises.paypal;
            }
            // PayPal is already available from payment-simulation.js
            window.librariesLoaded.paypal = true;
            window.libraryPromises.paypal = Promise.resolve(window.paypal);
            return window.libraryPromises.paypal;
        };
        
        // Wait for all critical libraries to load
        window.librariesReady = Promise.all([interactPromise, pdfLibPromise, configPromise, paymentPromise, emailPromise, signaturePadPromise])
            .then(() => {
                console.log('üéâ All critical libraries loaded successfully');
                
                // Ensure global variables are properly set
                if (!window.interact) {
                    console.warn('‚ö†Ô∏è Interact.js not found in global scope, loading fallback');
                    return loadScript(getAssetPath('interact-simulation.js'), 'interact', 'interact')
                        .catch(() => loadEmbeddedInteract());
                }
                if (!window.SignaturePad) {
                    console.warn('‚ö†Ô∏è SignaturePad not found in global scope, loading fallback');
                    return loadScript(getAssetPath('signature-pad.min.js'), 'SignaturePad', 'SignaturePad')
                        .catch(() => loadEmbeddedSignaturePad());
                }
                
                return true;
            })
            .catch(error => {
                console.error('üí• Library loading failed:', error);
                console.log('üîß Attempting to load fallback libraries...');
                
                // Load all fallbacks
                return Promise.all([
                    loadScript(getAssetPath('interact-simulation.js'), 'interact', 'interact').catch(() => {
                        console.error('Interact fallback failed, using embedded fallback');
                        return loadEmbeddedInteract();
                    }),
                    loadScript(getAssetPath('signature-pad.min.js'), 'SignaturePad', 'SignaturePad').catch(() => {
                        console.error('SignaturePad fallback failed, using embedded fallback');
                        return loadEmbeddedSignaturePad();
                    })
                ]).then(() => {
                    console.log('üõ†Ô∏è Fallback libraries loaded');
                    return true;
                });
            });

        // Embedded fallback functions for when all else fails
        function loadEmbeddedInteract() {
            return new Promise((resolve) => {
                // High-performance drag implementation with proper cursor feedback
                window.interact = function(selector) {
                    const elements = document.querySelectorAll(selector);
                    
                    return {
                        draggable: function(options) {
                            elements.forEach(element => {
                                let isDragging = false;
                                let startX, startY, startTransform = '';
                                let currentX = 0, currentY = 0;
                                
                                // Set up proper cursor states
                                element.style.cursor = 'grab';
                                element.style.userSelect = 'none';
                                element.style.touchAction = 'none';
                                
                                // Store initial transform
                                const computedStyle = window.getComputedStyle(element);
                                startTransform = computedStyle.transform !== 'none' ? computedStyle.transform : '';
                                
                                // Extract current position from transform or data attributes
                                currentX = parseFloat(element.getAttribute('data-x')) || 0;
                                currentY = parseFloat(element.getAttribute('data-y')) || 0;
                                
                                function startDrag(e) {
                                    e.preventDefault();
                                    isDragging = true;
                                    startX = e.clientX;
                                    startY = e.clientY;
                                    
                                    // Visual feedback
                                    element.style.cursor = 'grabbing';
                                    element.style.zIndex = '9999';
                                    element.style.opacity = '0.9';
                                    element.style.transform = `translate(${currentX}px, ${currentY}px) scale(1.02)`;
                                    element.classList.add('dragging');
                                    
                                    // Disable text selection during drag
                                    document.body.style.userSelect = 'none';
                                    
                                    if (options.listeners?.start) {
                                        options.listeners.start({ 
                                            target: element, 
                                            dx: 0, 
                                            dy: 0,
                                            clientX: e.clientX,
                                            clientY: e.clientY
                                        });
                                    }
                                }
                                
                                function doDrag(e) {
                                    if (!isDragging) return;
                                    e.preventDefault();
                                    
                                    const dx = e.clientX - startX;
                                    const dy = e.clientY - startY;
                                    
                                    currentX += dx;
                                    currentY += dy;
                                    
                                    // Use transform for smooth movement
                                    element.style.transform = `translate(${currentX}px, ${currentY}px) scale(1.02)`;
                                    
                                    // Update data attributes
                                    element.setAttribute('data-x', currentX);
                                    element.setAttribute('data-y', currentY);
                                    
                                    startX = e.clientX;
                                    startY = e.clientY;
                                    
                                    if (options.listeners?.move) {
                                        options.listeners.move({ 
                                            target: element, 
                                            dx: dx, 
                                            dy: dy,
                                            clientX: e.clientX,
                                            clientY: e.clientY
                                        });
                                    }
                                }
                                
                                function endDrag(e) {
                                    if (!isDragging) return;
                                    
                                    isDragging = false;
                                    
                                    // Reset visual feedback
                                    element.style.cursor = 'grab';
                                    element.style.zIndex = '';
                                    element.style.opacity = '';
                                    element.style.transform = `translate(${currentX}px, ${currentY}px)`;
                                    element.classList.remove('dragging');
                                    
                                    // Re-enable text selection
                                    document.body.style.userSelect = '';
                                    
                                    if (options.listeners?.end) {
                                        options.listeners.end({ 
                                            target: element, 
                                            dx: e.clientX - startX, 
                                            dy: e.clientY - startY,
                                            clientX: e.clientX,
                                            clientY: e.clientY
                                        });
                                    }
                                }
                                
                                // Mouse events
                                element.addEventListener('mousedown', startDrag);
                                document.addEventListener('mousemove', doDrag);
                                document.addEventListener('mouseup', endDrag);
                                
                                // Touch events for mobile
                                element.addEventListener('touchstart', (e) => {
                                    const touch = e.touches[0];
                                    startDrag({ 
                                        preventDefault: () => e.preventDefault(),
                                        clientX: touch.clientX, 
                                        clientY: touch.clientY 
                                    });
                                });
                                
                                document.addEventListener('touchmove', (e) => {
                                    if (isDragging) {
                                        const touch = e.touches[0];
                                        doDrag({ 
                                            preventDefault: () => e.preventDefault(),
                                            clientX: touch.clientX, 
                                            clientY: touch.clientY 
                                        });
                                    }
                                });
                                
                                document.addEventListener('touchend', (e) => {
                                    if (isDragging) {
                                        const touch = e.changedTouches[0];
                                        endDrag({ 
                                            clientX: touch.clientX, 
                                            clientY: touch.clientY 
                                        });
                                    }
                                });
                                
                                // Hover effects
                                element.addEventListener('mouseenter', () => {
                                    if (!isDragging) {
                                        element.style.cursor = 'grab';
                                        element.style.transform = `translate(${currentX}px, ${currentY}px) scale(1.01)`;
                                    }
                                });
                                
                                element.addEventListener('mouseleave', () => {
                                    if (!isDragging) {
                                        element.style.transform = `translate(${currentX}px, ${currentY}px)`;
                                    }
                                });
                            });
                            
                            return this;
                        },
                        
                        dropzone: function(options) {
                            elements.forEach(element => {
                                element.addEventListener('dragover', (e) => {
                                    e.preventDefault();
                                    if (options.ondrop) {
                                        element.style.backgroundColor = '#f0f8ff';
                                    }
                                });
                                
                                element.addEventListener('drop', (e) => {
                                    e.preventDefault();
                                    element.style.backgroundColor = '';
                                    
                                    if (options.ondrop) {
                                        options.ondrop({
                                            target: element,
                                            relatedTarget: e.target,
                                            dragEvent: e
                                        });
                                    }
                                });
                            });
                            
                            return this;
                        },
                        
                        resizable: function(options) {
                            elements.forEach(element => {
                                // Create resize handles for all edges and corners
                                const handles = {
                                    se: { cursor: 'se-resize', position: 'bottom-right' },
                                    sw: { cursor: 'sw-resize', position: 'bottom-left' },
                                    ne: { cursor: 'ne-resize', position: 'top-right' },
                                    nw: { cursor: 'nw-resize', position: 'top-left' },
                                    n: { cursor: 'n-resize', position: 'top-center' },
                                    s: { cursor: 's-resize', position: 'bottom-center' },
                                    e: { cursor: 'e-resize', position: 'right-center' },
                                    w: { cursor: 'w-resize', position: 'left-center' }
                                };
                                
                                element.style.position = 'relative';
                                
                                Object.keys(handles).forEach(direction => {
                                    const handle = document.createElement('div');
                                    handle.className = `resize-handle resize-handle-${direction}`;
                                    handle.style.cssText = getHandleStyles(direction, handles[direction]);
                                    
                                    let isResizing = false;
                                    let startX, startY, startWidth, startHeight, startLeft, startTop;
                                    let currentX = parseFloat(element.getAttribute('data-x')) || 0;
                                    let currentY = parseFloat(element.getAttribute('data-y')) || 0;
                                    
                                    function startResize(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        isResizing = true;
                                        
                                        startX = e.clientX;
                                        startY = e.clientY;
                                        
                                        const rect = element.getBoundingClientRect();
                                        startWidth = rect.width;
                                        startHeight = rect.height;
                                        startLeft = rect.left;
                                        startTop = rect.top;
                                        
                                        // Visual feedback
                                        element.style.transition = 'none';
                                        element.classList.add('resizing');
                                        document.body.style.cursor = handles[direction].cursor;
                                        document.body.style.userSelect = 'none';
                                        
                                        if (options.listeners?.start) {
                                            options.listeners.start({
                                                target: element,
                                                rect: { width: startWidth, height: startHeight }
                                            });
                                        }
                                    }
                                    
                                    function doResize(e) {
                                        if (!isResizing) return;
                                        e.preventDefault();
                                        
                                        const dx = e.clientX - startX;
                                        const dy = e.clientY - startY;
                                        
                                        let newWidth = startWidth;
                                        let newHeight = startHeight;
                                        let newX = currentX;
                                        let newY = currentY;
                                        
                                        // Calculate new dimensions based on resize direction
                                        if (direction.includes('e')) newWidth = Math.max(100, startWidth + dx);
                                        if (direction.includes('w')) {
                                            newWidth = Math.max(100, startWidth - dx);
                                            newX = currentX + dx;
                                        }
                                        if (direction.includes('s')) newHeight = Math.max(30, startHeight + dy);
                                        if (direction.includes('n')) {
                                            newHeight = Math.max(30, startHeight - dy);
                                            newY = currentY + dy;
                                        }
                                        
                                        // Apply changes
                                        element.style.width = newWidth + 'px';
                                        element.style.height = newHeight + 'px';
                                        element.style.transform = `translate(${newX}px, ${newY}px)`;
                                        
                                        // Update data attributes
                                        element.setAttribute('data-x', newX);
                                        element.setAttribute('data-y', newY);
                                        
                                        if (options.listeners?.move) {
                                            options.listeners.move({
                                                target: element,
                                                rect: { width: newWidth, height: newHeight },
                                                deltaRect: { 
                                                    left: newX - currentX, 
                                                    top: newY - currentY,
                                                    width: newWidth - startWidth,
                                                    height: newHeight - startHeight
                                                }
                                            });
                                        }
                                    }
                                    
                                    function endResize(e) {
                                        if (!isResizing) return;
                                        
                                        isResizing = false;
                                        
                                        // Reset visual feedback
                                        element.style.transition = 'all 0.2s ease';
                                        element.classList.remove('resizing');
                                        document.body.style.cursor = '';
                                        document.body.style.userSelect = '';
                                        
                                        // Update current position
                                        currentX = parseFloat(element.getAttribute('data-x')) || 0;
                                        currentY = parseFloat(element.getAttribute('data-y')) || 0;
                                        
                                        if (options.listeners?.end) {
                                            options.listeners.end({
                                                target: element,
                                                rect: { 
                                                    width: parseInt(element.style.width),
                                                    height: parseInt(element.style.height)
                                                }
                                            });
                                        }
                                    }
                                    
                                    // Mouse events
                                    handle.addEventListener('mousedown', startResize);
                                    document.addEventListener('mousemove', doResize);
                                    document.addEventListener('mouseup', endResize);
                                    
                                    // Touch events
                                    handle.addEventListener('touchstart', (e) => {
                                        const touch = e.touches[0];
                                        startResize({
                                            preventDefault: () => e.preventDefault(),
                                            stopPropagation: () => e.stopPropagation(),
                                            clientX: touch.clientX,
                                            clientY: touch.clientY
                                        });
                                    });
                                    
                                    document.addEventListener('touchmove', (e) => {
                                        if (isResizing) {
                                            const touch = e.touches[0];
                                            doResize({
                                                preventDefault: () => e.preventDefault(),
                                                clientX: touch.clientX,
                                                clientY: touch.clientY
                                            });
                                        }
                                    });
                                    
                                    document.addEventListener('touchend', (e) => {
                                        if (isResizing) {
                                            endResize({});
                                        }
                                    });
                                    
                                    element.appendChild(handle);
                                });
                                
                                function getHandleStyles(direction, config) {
                                    const baseStyles = `
                                        position: absolute;
                                        background: rgba(37, 99, 235, 0.8);
                                        border: 1px solid #2563eb;
                                        border-radius: 2px;
                                        z-index: 1001;
                                        opacity: 0;
                                        transition: all 0.2s ease;
                                        cursor: ${config.cursor};
                                    `;
                                    
                                    // 2px wider grab areas as requested
                                    const handleSize = '10px';
                                    const grabArea = '12px'; // 2px wider
                                    
                                    switch(direction) {
                                        case 'se':
                                            return baseStyles + `
                                                bottom: -6px; right: -6px;
                                                width: ${grabArea}; height: ${grabArea};
                                            `;
                                        case 'sw':
                                            return baseStyles + `
                                                bottom: -6px; left: -6px;
                                                width: ${grabArea}; height: ${grabArea};
                                            `;
                                        case 'ne':
                                            return baseStyles + `
                                                top: -6px; right: -6px;
                                                width: ${grabArea}; height: ${grabArea};
                                            `;
                                        case 'nw':
                                            return baseStyles + `
                                                top: -6px; left: -6px;
                                                width: ${grabArea}; height: ${grabArea};
                                            `;
                                        case 'n':
                                            return baseStyles + `
                                                top: -4px; left: 50%; transform: translateX(-50%);
                                                width: 30px; height: ${handleSize};
                                            `;
                                        case 's':
                                            return baseStyles + `
                                                bottom: -4px; left: 50%; transform: translateX(-50%);
                                                width: 30px; height: ${handleSize};
                                            `;
                                        case 'e':
                                            return baseStyles + `
                                                right: -4px; top: 50%; transform: translateY(-50%);
                                                width: ${handleSize}; height: 30px;
                                            `;
                                        case 'w':
                                            return baseStyles + `
                                                left: -4px; top: 50%; transform: translateY(-50%);
                                                width: ${handleSize}; height: 30px;
                                            `;
                                        default:
                                            return baseStyles;
                                    }
                                }
                            });
                            
                            return this;
                        }
                    };
                };

                // Add modifiers object
                window.interact.modifiers = {
                    restrictRect: () => ({}),
                    restrictEdges: () => ({}),
                    restrictSize: () => ({})
                };

                console.log('‚úÖ Embedded Interact.js fallback loaded');
                resolve(window.interact);
            });
        }

        function loadEmbeddedSignaturePad() {
            return new Promise((resolve) => {
                // Use the signature pad code we already created
                if (typeof window.SignaturePad === 'undefined') {
                    // The SignaturePad class is already defined in the signature-pad.min.js fallback
                    // Just ensure it's available
                    console.log('‚úÖ Embedded SignaturePad fallback loaded');
                }
                resolve(window.SignaturePad);
            });
        }

        function loadEmbeddedEmailService() {
            return new Promise((resolve) => {
                window.EmailService = class {
                    constructor() {
                        console.log('üìß Email Service initialized (embedded)');
                    }
                    
                    async sendFormSubmissionNotification(formData, submissionId) {
                        console.log('üìß Would send form submission notification:', formData);
                        return { success: true, messageId: 'embedded_' + Date.now() };
                    }
                    
                    async sendFormConfirmation(formData, recipientEmail, submissionId) {
                        console.log('üìß Would send confirmation to:', recipientEmail);
                        return { success: true, messageId: 'embedded_' + Date.now() };
                    }
                };
                
                window.emailService = new window.EmailService();
                console.log('‚úÖ Embedded Email Service loaded');
                resolve(window.EmailService);
            });
        }

        function loadEmbeddedPaymentProcessor() {
            return new Promise((resolve) => {
                window.PaymentProcessor = class {
                    constructor() {
                        console.log('üí≥ Payment Processor initialized (embedded)');
                    }
                    
                    async processStripePayment(amount, currency = 'usd') {
                        console.log('üí≥ Would process Stripe payment:', amount, currency);
                        return { success: true, transactionId: 'embedded_' + Date.now() };
                    }
                    
                    async processPayPalPayment(amount) {
                        console.log('üí≥ Would process PayPal payment:', amount);
                        return { success: true, transactionId: 'embedded_' + Date.now() };
                    }
                };
                
                window.paymentProcessor = new window.PaymentProcessor();
                console.log('‚úÖ Embedded Payment Processor loaded');
                resolve(window.PaymentProcessor);
            });
        }

        function loadEmbeddedConfigManager() {
            return new Promise((resolve) => {
                window.ConfigManager = class {
                    constructor() {
                        this.config = {
                            stripe: { enabled: false },
                            paypal: { enabled: false },
                            sendgrid: { enabled: false }
                        };
                        console.log('‚öôÔ∏è Config Manager initialized (embedded)');
                    }
                    
                    getConfig(service) {
                        return this.config[service] || {};
                    }
                    
                    updateConfig(service, settings) {
                        this.config[service] = { ...this.config[service], ...settings };
                        console.log('‚öôÔ∏è Config updated:', service, settings);
                    }
                };
                
                window.configManager = new window.ConfigManager();
                console.log('‚úÖ Embedded Config Manager loaded');
                resolve(window.ConfigManager);
            });
        }

        function loadEmbeddedPDFGenerator() {
            return new Promise((resolve) => {
                window.PDFGenerator = class {
                    constructor() {
                        console.log('üìÑ PDF Generator initialized (embedded)');
                    }
                    
                    async createFormSubmissionPDF(formData, options = {}) {
                        console.log('üìÑ Would create PDF for:', formData);
                        return new Uint8Array([37, 80, 68, 70]); // Mock PDF bytes
                    }
                    
                    async downloadPDF(pdfBytes, filename = 'document.pdf') {
                        console.log('üìÑ Would download PDF:', filename);
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };
                
                window.pdfGenerator = new window.PDFGenerator();
                console.log('‚úÖ Embedded PDF Generator loaded');
                resolve(window.PDFGenerator);
            });
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
        }
        .sidebar {
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: fixed;
            width: 250px;
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            min-height: 100vh;
        }
        .nav-link {
            color: #6b7280;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 2px 0;
        }
        .nav-link:hover, .nav-link.active {
            background: #2563eb;
            color: white !important;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card.primary { border-left-color: #2563eb; }
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.info { border-left-color: #06b6d4; }
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        .btn-create {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
            color: white;
        }
        
        /* Enhanced Styles for PDF and Interaction */
        .pdf-upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafafa;
            cursor: pointer;
        }
        .pdf-upload-zone:hover {
            border-color: #2563eb;
            background: #f0f7ff;
        }
        .pdf-upload-zone.dragover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .pdf-viewer {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
            position: relative;
        }
        
        .pdf-page {
            position: relative;
            margin: 10px auto;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-element-draggable {
            position: absolute;
            border: 2px dashed #2563eb;
            background: rgba(37, 99, 235, 0.1);
            padding: 8px;
            border-radius: 6px;
            cursor: move;
            min-width: 120px;
            min-height: 30px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .form-element-draggable:hover {
            border-color: #1e40af;
            background: rgba(37, 99, 235, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .form-element-draggable.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .form-element-draggable.dragging {
            opacity: 0.9;
            z-index: 9999;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: none;
            pointer-events: none;
        }
        
        .form-element-draggable {
            transition: all 0.2s ease;
            cursor: grab;
            user-select: none;
        }
        
        .form-element-draggable:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .form-element-draggable:active {
            cursor: grabbing;
        }
        
        /* Disable form inputs during form creation */
        .form-element-draggable input,
        .form-element-draggable textarea,
        .form-element-draggable select,
        .form-element-draggable button[type="submit"] {
            pointer-events: none;
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .form-element-draggable::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 1;
            cursor: grab;
        }
        
        .form-element-draggable.dragging::before {
            cursor: grabbing;
        }
        
        /* Resize handle styles */
        .resize-handle {
            position: absolute;
            background: rgba(37, 99, 235, 0.8);
            border: 1px solid #2563eb;
            border-radius: 2px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .form-element-draggable:hover .resize-handle {
            opacity: 1;
        }
        
        .form-element-draggable.resizing .resize-handle {
            opacity: 1;
            background: rgba(37, 99, 235, 1);
        }
        
        .form-element-draggable.resizing {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        /* Corner resize handles */
        .resize-handle-se, .resize-handle-sw, 
        .resize-handle-ne, .resize-handle-nw {
            width: 12px;
            height: 12px;
        }
        
        .resize-handle-se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }
        
        .resize-handle-sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }
        
        .resize-handle-ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }
        
        .resize-handle-nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }
        
        /* Edge resize handles */
        .resize-handle-n {
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            cursor: n-resize;
        }
        
        .resize-handle-s {
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            cursor: s-resize;
        }
        
        .resize-handle-e {
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 30px;
            cursor: e-resize;
        }
        
        .resize-handle-w {
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 30px;
            cursor: w-resize;
        }
        
        /* Hover effects for resize handles */
        .resize-handle:hover {
            background: rgba(37, 99, 235, 1);
            transform: scale(1.1);
        }
        
        .form-element-draggable.resizing {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .form-element-draggable .element-controls {
            position: absolute;
            top: -35px;
            right: 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            padding: 4px;
            display: none;
            z-index: 100;
            border: 1px solid #e5e7eb;
        }
        
        .form-element-draggable:hover .element-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .form-element-draggable .element-label {
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        /* Resize handles */
        .form-element-draggable::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #2563eb;
            cursor: se-resize;
            border-radius: 0 0 6px 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .form-element-draggable:hover::after {
            opacity: 0.7;
        }
        
        /* Canvas drop zone styling */
        #formCanvas.drag-over {
            background: #f0f7ff !important;
            border-color: #2563eb;
        }
        
        .payment-gateway-config {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .signature-pad-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            padding: 10px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: static;
                min-height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-3">
            <h4 class="text-primary mb-4">
                <i class="fas fa-file-signature me-2"></i>
                FormBuilder Pro
            </h4>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('my-forms')">
                        <i class="fas fa-file-alt me-2"></i>My Forms
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('create-form')">
                        <i class="fas fa-plus me-2"></i>Create Form
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('responses')">
                        <i class="fas fa-inbox me-2"></i>Responses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('signatures')">
                        <i class="fas fa-signature me-2"></i>Signatures
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('send-document')">
                        <i class="fas fa-paper-plane me-2"></i>Send Document
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('templates')">
                        <i class="fas fa-copy me-2"></i>Templates
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('bulk-send')">
                        <i class="fas fa-paper-plane me-2"></i>Bulk Send
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('tracking')">
                        <i class="fas fa-eye me-2"></i>Tracking
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('payments')">
                        <i class="fas fa-credit-card me-2"></i>Payments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('compliance')">
                        <i class="fas fa-shield-alt me-2"></i>Compliance
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('analytics')">
                        <i class="fas fa-chart-bar me-2"></i>Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="configManager.openConfigModal()">
                        <i class="fas fa-cog me-2"></i>API Settings
                    </a>
                </li>
            </ul>
            
            <div class="mt-auto pt-4">
                <div class="user-info p-3 bg-light rounded">
                    <div class="d-flex align-items-center">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                            <span id="userInitials">AU</span>
                        </div>
                        <div>
                            <div class="fw-bold" id="userName">Admin User</div>
                            <small class="text-muted" id="userEmail">{{USER_EMAIL}}</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-danger btn-sm w-100 mt-2" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <h1 class="h3 mb-4">Welcome back, <span id="headerUserName">Admin User</span>!</h1>
                
                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card primary">
                            <div class="stat-number text-primary" id="totalForms">0</div>
                            <div class="stat-label">Total Forms</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card success">
                            <div class="stat-number text-success" id="totalResponses">0</div>
                            <div class="stat-label">Total Responses</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card warning">
                            <div class="stat-number text-warning" id="totalSignatures">0</div>
                            <div class="stat-label">Signatures Collected</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card info">
                            <div class="stat-number text-info" id="activeForms">0</div>
                            <div class="stat-label">Active Forms</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5>Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-create" onclick="showSection('create-form')">
                                        <i class="fas fa-plus me-2"></i>Create New Form
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showSection('my-forms')">
                                        <i class="fas fa-file-alt me-2"></i>View My Forms
                                    </button>
                                    <button class="btn btn-outline-success" onclick="showSection('responses')">
                                        <i class="fas fa-inbox me-2"></i>Check Responses
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5>Recent Activity</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentActivity" class="text-center text-muted">
                                    <i class="fas fa-clock fa-2x mb-3"></i>
                                    <p>No recent activity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Forms Section -->
            <div id="my-forms-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>My Forms</h2>
                    <button class="btn btn-create" onclick="showSection('create-form')">
                        <i class="fas fa-plus me-2"></i>New Form
                    </button>
                </div>
                <div id="formsList" class="row">
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                            <h3>No forms yet</h3>
                            <p class="text-muted mb-4">Create your first form to get started</p>
                            <button class="btn btn-create" onclick="showSection('create-form')">
                                <i class="fas fa-plus me-2"></i>Create Your First Form
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Form Section -->
            <div id="create-form-section" class="content-section d-none">
                <h2 class="mb-4">Create New Form</h2>
                
                <!-- PDF Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-file-pdf me-2"></i>Upload Document (Optional)</h5>
                        <small class="text-muted">Upload a PDF to create fillable forms with drag-and-drop fields</small>
                    </div>
                    <div class="card-body">
                        <div id="pdfUploadZone" class="pdf-upload-zone" onclick="document.getElementById('pdfFileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Drop PDF here or click to upload</h5>
                            <p class="text-muted">Supported formats: PDF (max 10MB)</p>
                            <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" onchange="handlePDFUpload(event)">
                        </div>
                        
                        <div id="pdfProcessingZone" class="d-none">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary me-2" role="status"></div>
                                <span>Converting PDF to editable form...</span>
                            </div>
                        </div>
                        
                        <div id="pdfConvertedZone" class="d-none">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                PDF converted successfully! You can now add form fields by dragging elements onto the document.
                            </div>
                            <button class="btn btn-primary me-2" onclick="startFormEditing()">
                                <i class="fas fa-edit me-2"></i>Start Adding Fields
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearPDF()">
                                <i class="fas fa-times me-2"></i>Remove PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <input type="text" class="form-control" id="formTitle" placeholder="Enter form title..." value="Untitled Form">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-primary me-2" onclick="previewForm()">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                                <button class="btn btn-success" onclick="saveForm()">
                                    <i class="fas fa-save me-2"></i>Save Form
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Quick Demo Instructions -->
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Interactive Form Builder:</strong> Click any element below to add it to the canvas. 
                            Once added, you can <strong>drag to move</strong> and <strong>resize by dragging corners</strong>. 
                            Hover over elements to see edit/delete controls.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <h6>Form Elements</h6>
                                
                                <!-- Basic Elements -->
                                <div class="mb-3">
                                    <small class="text-muted fw-bold">BASIC FIELDS</small>
                                    <div class="d-grid gap-1 mt-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="addElement('text')">
                                            <i class="fas fa-font me-2"></i>Text Input
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="addElement('textarea')">
                                            <i class="fas fa-align-left me-2"></i>Text Area
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="addElement('select')">
                                            <i class="fas fa-list me-2"></i>Dropdown
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="addElement('checkbox')">
                                            <i class="fas fa-check-square me-2"></i>Checkboxes
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="addElement('radio')">
                                            <i class="fas fa-dot-circle me-2"></i>Radio Buttons
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- DocuSign Elements -->
                                <div class="mb-3">
                                    <small class="text-muted fw-bold">SIGNATURE FIELDS</small>
                                    <div class="d-grid gap-1 mt-2">
                                        <button class="btn btn-outline-success btn-sm" onclick="addElement('signature')">
                                            <i class="fas fa-signature me-2"></i>Signature Pad
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="addElement('initials')">
                                            <i class="fas fa-pen-fancy me-2"></i>Initials
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="addElement('signhere')">
                                            <i class="fas fa-hand-point-right me-2"></i>Sign Here
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('dateSigned')">
                                            <i class="fas fa-calendar me-2"></i>Date Signed
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Data Fields -->
                                <div class="mb-3">
                                    <small class="text-muted fw-bold">DATA FIELDS</small>
                                    <div class="d-grid gap-1 mt-2">
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('name')">
                                            <i class="fas fa-user me-2"></i>Full Name
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('email')">
                                            <i class="fas fa-envelope me-2"></i>Email
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('company')">
                                            <i class="fas fa-building me-2"></i>Company
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('title')">
                                            <i class="fas fa-id-badge me-2"></i>Title
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="addElement('date')">
                                            <i class="fas fa-calendar-alt me-2"></i>Date Picker
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Advanced Elements -->
                                <div class="mb-3">
                                    <small class="text-muted fw-bold">ADVANCED</small>
                                    <div class="d-grid gap-1 mt-2">
                                        <button class="btn btn-outline-warning btn-sm" onclick="addElement('file')">
                                            <i class="fas fa-file-upload me-2"></i>File Upload
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="addElement('payment')">
                                            <i class="fas fa-credit-card me-2"></i>Payment
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="addElement('formula')">
                                            <i class="fas fa-calculator me-2"></i>Formula
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="addElement('label')">
                                            <i class="fas fa-tag me-2"></i>Label
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <!-- PDF Viewer for interactive editing -->
                                <div id="pdfViewer" class="pdf-viewer d-none">
                                    <div class="p-3 bg-light border-bottom">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <h6 class="mb-0">Interactive PDF Form Editor</h6>
                                                <small class="text-muted">Drag form elements from the left panel onto the PDF</small>
                                            </div>
                                            <div class="col-auto">
                                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="zoomOut()">
                                                    <i class="fas fa-search-minus"></i>
                                                </button>
                                                <span id="zoomLevel">100%</span>
                                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="zoomIn()">
                                                    <i class="fas fa-search-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="pdfPages" class="p-3">
                                        <!-- PDF pages will be rendered here -->
                                    </div>
                                </div>
                                
                                <!-- Traditional Form Builder -->
                                <div id="formCanvas" class="border rounded p-3 position-relative" style="min-height: 400px; background: #fafafa;">
                                    <div id="canvasPlaceholder" class="text-center text-muted py-5">
                                        <i class="fas fa-plus-circle fa-3x mb-3"></i>
                                        <p>Click elements from the left to build your form</p>
                                        <p><small>Elements will be draggable and resizable once added</small></p>
                                        <p><small>Or upload a PDF above for document-based forms</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Sections -->
            <div id="responses-section" class="content-section d-none">
                <h2 class="mb-4">Form Responses</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Responses will appear here when users submit your forms.
                </div>
            </div>

            <div id="signatures-section" class="content-section d-none">
                <h2 class="mb-4">Digital Signatures</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Digital signatures from your forms will be displayed here.
                </div>
            </div>

            <!-- Send Document Section -->
            <div id="send-document-section" class="content-section d-none">
                <h2 class="mb-4">Send Document for Signature</h2>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Select Document</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="documentSelect" class="form-label">Choose Document</label>
                                    <select class="form-control" id="documentSelect">
                                        <option value="">Select a document...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">Email Subject</label>
                                    <input type="text" class="form-control" id="emailSubject" placeholder="Please sign this document">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="emailMessage" class="form-label">Personal Message</label>
                                    <textarea class="form-control" id="emailMessage" rows="3" placeholder="Please review and sign this document at your earliest convenience."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Recipients</h5>
                            </div>
                            <div class="card-body">
                                <div id="recipientsList">
                                    <div class="recipient-item mb-3 p-3 border rounded">
                                        <div class="mb-2">
                                            <input type="email" class="form-control form-control-sm" placeholder="Email address" name="recipientEmail">
                                        </div>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" placeholder="Full name" name="recipientName">
                                        </div>
                                        <div>
                                            <select class="form-control form-control-sm" name="recipientRole">
                                                <option value="signer">Signer</option>
                                                <option value="cc">CC</option>
                                                <option value="viewer">Viewer</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addRecipient()">
                                    <i class="fas fa-plus me-2"></i>Add Recipient
                                </button>
                                
                                <button type="button" class="btn btn-success w-100" onclick="sendDocument()">
                                    <i class="fas fa-paper-plane me-2"></i>Send for Signature
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Section -->
            <div id="tracking-section" class="content-section d-none">
                <h2 class="mb-4">Document Tracking</h2>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="stat-number text-warning" id="pendingSignatures">0</div>
                            <div class="stat-label">Pending Signatures</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="stat-number text-success" id="completedSignatures">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card info">
                            <div class="stat-number text-info" id="averageSignTime">0h</div>
                            <div class="stat-label">Avg. Sign Time</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-number text-primary" id="totalSent">0</div>
                            <div class="stat-label">Total Sent</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Sent Documents</h5>
                    </div>
                    <div class="card-body">
                        <div id="sentDocumentsList">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-file-signature fa-3x mb-3"></i>
                                <p>No documents sent yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates Section -->
            <div id="templates-section" class="content-section d-none">
                <h2 class="mb-4">Document Templates</h2>
                
                <!-- Quick Start Banner -->
                <div class="alert alert-primary border-0 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-2"><i class="fas fa-rocket me-2"></i>Ready-to-Use Professional Templates</h5>
                            <p class="mb-0">Choose from 8 professionally designed templates including contracts, NDAs, employment forms, invoices, and more. Each template includes required fields, signatures, and payment processing.</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-lg" onclick="showSection('create-form')">
                                <i class="fas fa-plus me-2"></i>Create Custom Form
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="createNewTemplate()">
                            <i class="fas fa-plus me-2"></i>Create Custom Template
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="showTemplateGallery()">
                            <i class="fas fa-images me-2"></i>Template Gallery
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" onclick="importTemplate()">
                                <i class="fas fa-upload me-2"></i>Import
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportTemplates()">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                            <button class="btn btn-outline-info" onclick="refreshTemplates()">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Template Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-number text-primary" id="totalTemplates">8</div>
                            <div class="stat-label">Available Templates</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="stat-number text-success" id="usedTemplates">0</div>
                            <div class="stat-label">Templates Used</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card info">
                            <div class="stat-number text-info" id="templateCategories">8</div>
                            <div class="stat-label">Categories</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="stat-number text-warning" id="customTemplates">0</div>
                            <div class="stat-label">Custom Templates</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">Professional Document Templates</h5>
                                <small class="text-muted">Click "Use" to create a new form based on any template</small>
                            </div>
                            <div class="col-auto">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showOnlyCustom">
                                    <label class="form-check-label" for="showOnlyCustom">
                                        Show only custom templates
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="templatesList">
                            <div class="text-center py-4 text-muted">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading templates...</span>
                                </div>
                                <p class="mt-2">Loading templates...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Send Section -->
            <div id="bulk-send-section" class="content-section d-none">
                <h2 class="mb-4">Bulk Send Documents</h2>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Setup Bulk Send</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Template</label>
                                    <select class="form-control" id="bulkTemplate">
                                        <option value="">Choose a template...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Upload Recipients CSV</label>
                                    <input type="file" class="form-control" id="recipientsFile" accept=".csv">
                                    <small class="text-muted">CSV should have columns: name, email, role</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Message</label>
                                    <textarea class="form-control" id="bulkMessage" rows="3" placeholder="Personal message for all recipients"></textarea>
                                </div>
                                
                                <button class="btn btn-success" onclick="processBulkSend()">
                                    <i class="fas fa-paper-plane me-2"></i>Send to All Recipients
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Bulk Send Statistics</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total Recipients:</span>
                                    <strong id="bulkRecipientCount">0</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Estimated Cost:</span>
                                    <strong id="bulkEstimatedCost">$0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Processing Time:</span>
                                    <strong id="bulkProcessingTime">~0 min</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments-section" class="content-section d-none">
                <h2 class="mb-4">Payment Management</h2>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="stat-number text-success" id="totalRevenue">$0</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="stat-number text-warning" id="pendingPayments">0</div>
                            <div class="stat-label">Pending Payments</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card danger">
                            <div class="stat-number text-danger" id="failedPayments">0</div>
                            <div class="stat-label">Failed Payments</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card info">
                            <div class="stat-number text-info" id="processingFees">$0</div>
                            <div class="stat-label">Processing Fees</div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Gateway Configuration -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fab fa-stripe me-2"></i>Stripe Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Stripe Publishable Key</label>
                                    <input type="text" class="form-control" id="stripePublishableKey" placeholder="pk_test_...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Stripe Secret Key</label>
                                    <input type="password" class="form-control" id="stripeSecretKey" placeholder="sk_test_...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Webhook Endpoint Secret</label>
                                    <input type="password" class="form-control" id="stripeWebhookSecret" placeholder="whsec_...">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="stripeEnabled" checked>
                                    <label class="form-check-label" for="stripeEnabled">
                                        Enable Stripe Payments
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="testStripeConnection()">
                                    <i class="fas fa-plug me-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fab fa-paypal me-2"></i>PayPal Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">PayPal Client ID</label>
                                    <input type="text" class="form-control" id="paypalClientId" placeholder="Client ID">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PayPal Client Secret</label>
                                    <input type="password" class="form-control" id="paypalClientSecret" placeholder="Client Secret">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Environment</label>
                                    <select class="form-control" id="paypalEnvironment">
                                        <option value="sandbox">Sandbox (Testing)</option>
                                        <option value="live">Live (Production)</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="paypalEnabled">
                                    <label class="form-check-label" for="paypalEnabled">
                                        Enable PayPal Payments
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="testPayPalConnection()">
                                    <i class="fas fa-plug me-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SendGrid Email Configuration -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope me-2"></i>SendGrid Email Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SendGrid API Key</label>
                                    <input type="password" class="form-control" id="sendgridApiKey" placeholder="SG.xxxxx">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">From Email Address</label>
                                    <input type="email" class="form-control" id="sendgridFromEmail" placeholder="noreply@yourdomain.com">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">From Name</label>
                                    <input type="text" class="form-control" id="sendgridFromName" placeholder="FormBuilder Pro">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email Templates</label>
                                    <select class="form-control" id="emailTemplate">
                                        <option value="document_ready">Document Ready for Signature</option>
                                        <option value="document_completed">Document Completed</option>
                                        <option value="payment_received">Payment Received</option>
                                        <option value="reminder">Signature Reminder</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sendgridEnabled">
                                    <label class="form-check-label" for="sendgridEnabled">
                                        Enable SendGrid Email Notifications
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="testSendGridConnection()">
                                    <i class="fas fa-paper-plane me-2"></i>Send Test Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Gateway</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No transactions yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Section -->
            <div id="compliance-section" class="content-section d-none">
                <h2 class="mb-4">Compliance & Security</h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Security Features</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="twoFactorAuth" checked>
                                    <label class="form-check-label" for="twoFactorAuth">
                                        Two-Factor Authentication
                                    </label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="encryptionEnabled" checked>
                                    <label class="form-check-label" for="encryptionEnabled">
                                        AES-256 Encryption
                                    </label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="auditLogging" checked>
                                    <label class="form-check-label" for="auditLogging">
                                        Audit Trail Logging
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ipRestriction">
                                    <label class="form-check-label" for="ipRestriction">
                                        IP Address Restrictions
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Compliance Standards</h5>
                            </div>
                            <div class="card-body">
                                <div class="compliance-item mb-3">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>ESIGN Act Compliant</strong>
                                    <p class="mb-0 text-muted small">Electronic signatures are legally binding</p>
                                </div>
                                <div class="compliance-item mb-3">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>UETA Compliant</strong>
                                    <p class="mb-0 text-muted small">Uniform Electronic Transactions Act</p>
                                </div>
                                <div class="compliance-item mb-3">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>eIDAS Compliant</strong>
                                    <p class="mb-0 text-muted small">European digital signature standard</p>
                                </div>
                                <div class="compliance-item">
                                    <i class="fas fa-shield-alt text-info me-2"></i>
                                    <strong>SOC 2 Type II</strong>
                                    <p class="mb-0 text-muted small">Security and availability audited</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Certificate of Completion</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate tamper-proof certificates for completed documents</p>
                        <button class="btn btn-primary" onclick="generateComplianceReport()">
                            <i class="fas fa-certificate me-2"></i>Generate Compliance Report
                        </button>
                    </div>
                </div>
            </div>

            <div id="analytics-section" class="content-section d-none">
                <h2 class="mb-4">Advanced Analytics</h2>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-number text-primary" id="analyticsTotal">0</div>
                            <div class="stat-label">Total Documents</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="stat-number text-success" id="analyticsCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card info">
                            <div class="stat-number text-info" id="analyticsRate">0%</div>
                            <div class="stat-label">Completion Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="stat-number text-warning" id="analyticsTime">0h</div>
                            <div class="stat-label">Avg. Sign Time</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Signing Trends</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="trendsChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Top Signers</h5>
                            </div>
                            <div class="card-body">
                                <div id="topSignersList">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-user-friends fa-2x mb-2"></i>
                                        <p>No signing data yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script>
        // Check authentication on page load
        // Check authentication (skip in editor mode)
        if (!TemplateAuth.isLoggedIn() && window.self === window.top) {
            window.location.href = 'login.html';
        }

        // Load user data
        const currentUser = TemplateAuth.getCurrentUser();
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('headerUserName').textContent = currentUser.name.split(' ')[0];
            document.getElementById('userInitials').textContent = currentUser.name.split(' ').map(n => n[0]).join('');
        }

        // Global variables
        let currentFormElements = [];
        let elementCounter = 0;

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('d-none');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('d-none');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load section-specific data
            if (sectionName === 'dashboard') {
                loadDashboardData();
            } else if (sectionName === 'send-document') {
                loadDocumentSelect();
            } else if (sectionName === 'tracking') {
                loadTrackingData();
            }
        }

        // DocuSign-style functions
        function loadDocumentSelect() {
            const forms = TemplateAuth.getUserForms();
            const documentSelect = document.getElementById('documentSelect');
            documentSelect.innerHTML = '<option value="">Select a document...</option>';
            
            forms.forEach(form => {
                const option = document.createElement('option');
                option.value = form.id;
                option.textContent = form.title;
                documentSelect.appendChild(option);
            });
        }

        function addRecipient() {
            const recipientsList = document.getElementById('recipientsList');
            const recipientItem = document.createElement('div');
            recipientItem.className = 'recipient-item mb-3 p-3 border rounded position-relative';
            recipientItem.innerHTML = `
                <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="mb-2">
                    <input type="email" class="form-control form-control-sm" placeholder="Email address" name="recipientEmail">
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Full name" name="recipientName">
                </div>
                <div>
                    <select class="form-control form-control-sm" name="recipientRole">
                        <option value="signer">Signer</option>
                        <option value="cc">CC</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
            `;
            recipientsList.appendChild(recipientItem);
        }

        function sendDocument() {
            const documentId = document.getElementById('documentSelect').value;
            const emailSubject = document.getElementById('emailSubject').value;
            const emailMessage = document.getElementById('emailMessage').value;
            
            if (!documentId) {
                alert('Please select a document');
                return;
            }
            
            const recipientItems = document.querySelectorAll('.recipient-item');
            const recipients = [];
            
            recipientItems.forEach((item, index) => {
                const email = item.querySelector('[name="recipientEmail"]').value;
                const name = item.querySelector('[name="recipientName"]').value;
                const role = item.querySelector('[name="recipientRole"]').value;
                
                if (email) {
                    recipients.push({
                        email: email,
                        name: name || email,
                        role: role,
                        order: index + 1
                    });
                }
            });
            
            if (recipients.length === 0) {
                alert('Please add at least one recipient');
                return;
            }
            
            const success = window.sendForm(documentId, recipients, emailMessage);
            if (success) {
                alert('Document sent successfully! Recipients will receive email notifications.');
                showSection('tracking');
            } else {
                alert('Error sending document');
            }
        }

        function loadTrackingData() {
            const forms = TemplateAuth.getUserForms();
            const sentForms = forms.filter(form => form.status === 'sent' || form.status === 'completed');
            
            // Update statistics
            let pendingCount = 0;
            let completedCount = 0;
            let totalSent = sentForms.length;
            
            sentForms.forEach(form => {
                const status = window.getSigningStatus(form.id);
                if (status) {
                    pendingCount += status.pending;
                    completedCount += status.completed;
                }
            });
            
            document.getElementById('pendingSignatures').textContent = pendingCount;
            document.getElementById('completedSignatures').textContent = completedCount;
            document.getElementById('totalSent').textContent = totalSent;
            document.getElementById('averageSignTime').textContent = '2.5h'; // Mock data
            
            // Load sent documents list
            const sentDocumentsList = document.getElementById('sentDocumentsList');
            
            if (sentForms.length === 0) {
                sentDocumentsList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-file-signature fa-3x mb-3"></i>
                        <p>No documents sent yet</p>
                    </div>
                `;
                return;
            }
            
            sentDocumentsList.innerHTML = '';
            
            sentForms.forEach(form => {
                const status = window.getSigningStatus(form.id);
                const sentDate = new Date(form.sentAt).toLocaleDateString();
                
                const documentCard = document.createElement('div');
                documentCard.className = 'border rounded p-3 mb-3';
                documentCard.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">${form.title}</h6>
                            <small class="text-muted">Sent on ${sentDate}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="progress mb-1" style="height: 8px;">
                                <div class="progress-bar ${form.status === 'completed' ? 'bg-success' : 'bg-warning'}" 
                                     style="width: ${status ? status.percentage : 0}%"></div>
                            </div>
                            <small class="text-muted">${status ? status.percentage : 0}% Complete</small>
                        </div>
                        <div class="col-md-3 text-end">
                            <span class="badge ${form.status === 'completed' ? 'bg-success' : 'bg-warning'}">${form.status}</span>
                            <div class="btn-group ms-2" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDocumentDetails('${form.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="sendRemindersFor('${form.id}')" title="Send Reminder">
                                    <i class="fas fa-bell"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="voidDocumentForm('${form.id}')" title="Void Document">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Recipients: ${form.recipients.map(r => r.email).join(', ')}</small>
                    </div>
                `;
                
                sentDocumentsList.appendChild(documentCard);
            });
        }

        function viewDocumentDetails(formId) {
            const form = TemplateAuth.getForm(formId);
            const status = window.getSigningStatus(formId);
            
            if (!form || !status) return;
            
            let recipientDetails = status.recipients.map(recipient => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${recipient.name}</strong><br>
                        <small class="text-muted">${recipient.email}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${recipient.status === 'completed' ? 'bg-success' : recipient.status === 'pending' ? 'bg-warning' : 'bg-danger'}">${recipient.status}</span><br>
                        ${recipient.signedAt ? `<small class="text-muted">Signed: ${new Date(recipient.signedAt).toLocaleDateString()}</small>` : 
                          recipient.status === 'pending' ? `<small class="text-muted">Sent: ${new Date(recipient.sentAt).toLocaleDateString()}</small>` : ''}
                    </div>
                </div>
            `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Document Details: ${form.title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Status:</strong> ${form.status}<br>
                                    <strong>Sent:</strong> ${new Date(form.sentAt).toLocaleDateString()}<br>
                                    ${form.completedAt ? `<strong>Completed:</strong> ${new Date(form.completedAt).toLocaleDateString()}<br>` : ''}
                                </div>
                                <div class="col-md-6">
                                    <strong>Progress:</strong> ${status.completed}/${status.total} signatures<br>
                                    <div class="progress mt-2">
                                        <div class="progress-bar ${form.status === 'completed' ? 'bg-success' : 'bg-warning'}" 
                                             style="width: ${status.percentage}%">${status.percentage}%</div>
                                    </div>
                                </div>
                            </div>
                            <h6>Recipients</h6>
                            <div>${recipientDetails}</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function sendRemindersFor(formId) {
            const success = window.sendReminders(formId);
            if (success) {
                alert('Reminders sent to pending recipients!');
                loadTrackingData();
            } else {
                alert('Error sending reminders');
            }
        }

        function voidDocumentForm(formId) {
            const reason = prompt('Please enter a reason for voiding this document:');
            if (reason !== null) {
                const success = window.voidDocument(formId, reason);
                if (success) {
                    alert('Document has been voided successfully');
                    loadTrackingData();
                } else {
                    alert('Error voiding document');
                }
            }
        }

        // Load dashboard data
        function loadDashboardData() {
            const forms = TemplateAuth.getUserForms();
            const totalResponses = forms.reduce((total, form) => total + form.responses.length, 0);
            const signatures = forms.filter(form => form.settings.requireSignature).length;
            const activeForms = forms.filter(form => form.status === 'published').length;
            
            document.getElementById('totalForms').textContent = forms.length;
            document.getElementById('totalResponses').textContent = totalResponses;
            document.getElementById('totalSignatures').textContent = signatures;
            document.getElementById('activeForms').textContent = activeForms;
        }

        // Form builder functions (main addElement function is defined later)

        function removeElement(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (element) {
                element.remove();
                currentFormElements = currentFormElements.filter(el => el.id !== elementId);
                
                // Show placeholder if no elements left in canvas
                if (currentFormElements.length === 0) {
                    const placeholder = document.getElementById('canvasPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                }
            }
        }

        function saveForm() {
            const title = document.getElementById('formTitle').value;
            if (!title.trim()) {
                alert('Please enter a form title');
                return;
            }
            
            const formData = {
                title: title,
                description: '',
                fields: currentFormElements,
                requireSignature: currentFormElements.some(el => el.type === 'signature')
            };
            
            const formId = TemplateAuth.createForm(formData);
            if (formId) {
                alert('Form saved successfully!');
                showSection('my-forms');
                loadDashboardData();
            } else {
                alert('Error saving form');
            }
        }

        function previewForm() {
            alert('Form preview feature - opens in new window in production');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                TemplateAuth.logout();
                window.location.href = 'login.html';
            }
        }

        // DocuClone Advanced Features

        // Templates functionality
        function createNewTemplate() {
            const title = prompt('Enter template name:');
            if (!title) return;
            
            const templateData = {
                title: title,
                description: 'New template',
                fields: currentFormElements,
                requireSignature: true
            };
            
            const templateId = TemplateAuth.createTemplate(templateData);
            if (templateId) {
                alert('Template created successfully!');
                loadTemplatesList();
            }
        }

        function loadTemplatesList() {
            const forms = TemplateAuth.getUserForms();
            const templates = forms.filter(form => form.isTemplate);
            const templatesList = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                templatesList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-copy fa-3x mb-3"></i>
                        <p>No templates created yet</p>
                    </div>
                `;
                return;
            }
            
            templatesList.innerHTML = '';
            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'border rounded p-3 mb-3';
                templateCard.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6>${template.title}</h6>
                            <small class="text-muted">Created: ${new Date(template.createdAt).toLocaleDateString()}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-info me-2">Used ${template.usageCount || 0} times</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="useTemplate('${template.id}')">Use</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editTemplate('${template.id}')">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                templatesList.appendChild(templateCard);
            });
        }

        // Bulk Send functionality
        function processBulkSend() {
            const templateId = document.getElementById('bulkTemplate').value;
            const file = document.getElementById('recipientsFile').files[0];
            const message = document.getElementById('bulkMessage').value;
            
            if (!templateId || !file) {
                alert('Please select a template and upload recipients file');
                return;
            }
            
            // Simulate CSV processing
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const recipients = [];
                
                // Skip header row
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length >= 2 && cols[1].trim()) {
                        recipients.push({
                            name: cols[0] ? cols[0].trim() : cols[1].trim(),
                            email: cols[1].trim(),
                            role: cols[2] ? cols[2].trim() : 'signer'
                        });
                    }
                }
                
                if (recipients.length === 0) {
                    alert('No valid recipients found in CSV');
                    return;
                }
                
                // Group recipients into batches (simulate individual sends)
                const recipientsBatches = recipients.map(r => [r]);
                
                const sentForms = TemplateAuth.bulkSend(templateId, recipientsBatches, message);
                if (sentForms && sentForms.length > 0) {
                    alert(`Successfully sent to ${sentForms.length} recipients!`);
                    showSection('tracking');
                } else {
                    alert('Error sending bulk documents');
                }
            };
            reader.readAsText(file);
        }

        // Advanced Analytics
        function loadAdvancedAnalytics() {
            const analytics = TemplateAuth.getAnalytics('30d');
            
            document.getElementById('analyticsTotal').textContent = analytics.totalDocuments;
            document.getElementById('analyticsCompleted').textContent = analytics.completedDocuments;
            document.getElementById('analyticsRate').textContent = analytics.completionRate + '%';
            document.getElementById('analyticsTime').textContent = analytics.averageSigningTime + 'h';
            
            // Load top signers
            const topSignersList = document.getElementById('topSignersList');
            if (analytics.topSigners.length === 0) {
                topSignersList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-user-friends fa-2x mb-2"></i>
                        <p>No signing data yet</p>
                    </div>
                `;
            } else {
                topSignersList.innerHTML = '';
                analytics.topSigners.forEach((signer, index) => {
                    const signerItem = document.createElement('div');
                    signerItem.className = 'd-flex justify-content-between align-items-center mb-2';
                    signerItem.innerHTML = `
                        <div>
                            <strong>${signer.name}</strong><br>
                            <small class="text-muted">${signer.email}</small>
                        </div>
                        <span class="badge bg-primary">${signer.count}</span>
                    `;
                    topSignersList.appendChild(signerItem);
                });
            }
        }

        // Enhanced PDF Processing and Interactive Editing
        let currentPDF = null;
        let pdfPages = [];
        let currentZoom = 1.0;
        let interactInitialized = false;

        // PDF Upload and Processing
        async function handlePDFUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please upload a valid PDF file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File size must be less than 10MB');
                return;
            }

            showPDFProcessing();

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const numPages = pdfDoc.getPageCount();

                currentPDF = {
                    document: pdfDoc,
                    arrayBuffer: arrayBuffer,
                    filename: file.name,
                    pageCount: numPages
                };

                await renderPDFPages();
                showPDFConverted();
                
            } catch (error) {
                console.error('PDF processing error:', error);
                alert('Error processing PDF. Please try a different file.');
                hidePDFProcessing();
            }
        }

        function showPDFProcessing() {
            document.getElementById('pdfUploadZone').classList.add('d-none');
            document.getElementById('pdfProcessingZone').classList.remove('d-none');
        }

        function hidePDFProcessing() {
            document.getElementById('pdfUploadZone').classList.remove('d-none');
            document.getElementById('pdfProcessingZone').classList.add('d-none');
        }

        function showPDFConverted() {
            document.getElementById('pdfProcessingZone').classList.add('d-none');
            document.getElementById('pdfConvertedZone').classList.remove('d-none');
        }

        async function renderPDFPages() {
            const pagesContainer = document.getElementById('pdfPages');
            pagesContainer.innerHTML = '';
            pdfPages = [];

            for (let i = 0; i < currentPDF.pageCount; i++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page';
                pageDiv.id = `pdf-page-${i}`;
                
                try {
                    // Create canvas for page rendering
                    const canvas = document.createElement('canvas');
                    canvas.width = 800;
                    canvas.height = 1100;
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                    canvas.style.border = '1px solid #dee2e6';
                    
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Add placeholder content
                    ctx.fillStyle = '#666';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`PDF Page ${i + 1}`, canvas.width / 2, canvas.height / 2);
                    
                    pageDiv.appendChild(canvas);
                    pagesContainer.appendChild(pageDiv);
                    
                    pdfPages.push({
                        pageNumber: i,
                        canvas: canvas,
                        element: pageDiv,
                        formElements: []
                    });
                    
                } catch (error) {
                    console.error(`Error rendering page ${i + 1}:`, error);
                }
            }
        }

        function startFormEditing() {
            document.getElementById('formCanvas').classList.add('d-none');
            document.getElementById('pdfViewer').classList.remove('d-none');
            
            if (!interactInitialized) {
                initializeInteractJS();
                interactInitialized = true;
            }
        }

        function clearPDF() {
            currentPDF = null;
            pdfPages = [];
            document.getElementById('pdfConvertedZone').classList.add('d-none');
            document.getElementById('pdfUploadZone').classList.remove('d-none');
            document.getElementById('pdfViewer').classList.add('d-none');
            document.getElementById('formCanvas').classList.remove('d-none');
            document.getElementById('pdfFileInput').value = '';
        }

        // Interactive Form Element Handling with Interact.js
        async function initializeInteractJS() {
            // Wait for Interact.js to load before initializing
            if (!window.librariesLoaded.interact) {
                console.log('‚è≥ Waiting for Interact.js to load...');
                try {
                    await window.libraryPromises.interact;
                } catch (error) {
                    console.error('‚ùå Failed to load Interact.js:', error);
                    alert('Failed to load interactive features. Please refresh the page.');
                    return;
                }
            }
            
            if (typeof interact === 'undefined') {
                console.error('‚ùå Interact.js is not available');
                alert('Interactive features are not available. Please refresh the page.');
                return;
            }
            
            console.log('üéØ Initializing Interact.js features...');
            
            // Enable drop zones on PDF pages
            interact('.pdf-page').dropzone({
                accept: '.form-element-draggable',
                overlap: 0.1,
                ondrop: function (event) {
                    const draggedElement = event.relatedTarget;
                    const dropzone = event.target;
                    
                    // Position element relative to page
                    const rect = dropzone.getBoundingClientRect();
                    const x = event.dragEvent.client.x - rect.left;
                    const y = event.dragEvent.client.y - rect.top;
                    
                    draggedElement.style.left = x + 'px';
                    draggedElement.style.top = y + 'px';
                    draggedElement.style.position = 'absolute';
                    
                    dropzone.appendChild(draggedElement);
                }
            });

            // Enable drop zones on form canvas
            interact('#formCanvas').dropzone({
                accept: '.form-element-draggable',
                overlap: 0.1,
                ondrop: function (event) {
                    const draggedElement = event.relatedTarget;
                    const dropzone = event.target;
                    
                    // Position element relative to canvas
                    const rect = dropzone.getBoundingClientRect();
                    const x = event.dragEvent.client.x - rect.left;
                    const y = event.dragEvent.client.y - rect.top;
                    
                    draggedElement.style.left = x + 'px';
                    draggedElement.style.top = y + 'px';
                    draggedElement.style.position = 'absolute';
                    
                    // Reset transform if it was being dragged
                    draggedElement.style.transform = '';
                    draggedElement.setAttribute('data-x', 0);
                    draggedElement.setAttribute('data-y', 0);
                }
            });
        }

        async function makeElementInteractive(element) {
            // Wait for Interact.js to be available
            if (!window.librariesLoaded.interact) {
                try {
                    await window.libraryPromises.interact;
                } catch (error) {
                    console.error('‚ùå Failed to load Interact.js for element interaction:', error);
                    return;
                }
            }
            
            if (typeof interact === 'undefined') {
                console.error('‚ùå Interact.js is not available for element interaction');
                return;
            }
            
            // Make individual element draggable and resizable
            interact(element)
                .draggable({
                    inertia: true,
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent',
                            endOnly: true
                        })
                    ],
                    autoScroll: true,
                    listeners: {
                        move: dragMoveListener,
                        start: function (event) {
                            // Add visual feedback when dragging starts
                            event.target.classList.add('dragging');
                            document.getElementById('formCanvas').classList.add('drag-over');
                        },
                        end: function (event) {
                            // Remove visual feedback when dragging ends
                            event.target.classList.remove('dragging');
                            document.getElementById('formCanvas').classList.remove('drag-over');
                            console.log('Drag ended', event);
                        }
                    }
                })
                .resizable({
                    edges: { left: true, right: true, bottom: true, top: true },
                    listeners: {
                        start: function (event) {
                            // Add visual feedback when resizing starts
                            event.target.classList.add('resizing');
                        },
                        move: function (event) {
                            const target = event.target;
                            let x = (parseFloat(target.getAttribute('data-x')) || 0);
                            let y = (parseFloat(target.getAttribute('data-y')) || 0);

                            target.style.width = event.rect.width + 'px';
                            target.style.height = event.rect.height + 'px';

                            x += event.deltaRect.left;
                            y += event.deltaRect.top;

                            target.style.transform = 'translate(' + x + 'px,' + y + 'px)';

                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        },
                        end: function (event) {
                            // Remove visual feedback when resizing ends
                            event.target.classList.remove('resizing');
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictEdges({
                            outer: 'parent'
                        }),
                        interact.modifiers.restrictSize({
                            min: { width: 100, height: 30 }
                        })
                    ],
                    inertia: true
                });
        }

        function dragMoveListener(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

            target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        // Enhanced addElement function for both PDF and canvas mode
        function addElement(type) {
            elementCounter++;
            const elementId = `element_${elementCounter}`;
            
            // Check if we're in PDF mode or canvas mode
            const pdfViewer = document.getElementById('pdfViewer');
            const isPDFMode = !pdfViewer.classList.contains('d-none');
            
            if (isPDFMode) {
                // PDF interactive mode
                addElementToPDF(type, elementId);
            } else {
                // Traditional form building mode
                addElementToCanvas(type, elementId);
            }
        }

        function addElementToCanvas(type, elementId) {
            const canvas = document.getElementById('formCanvas');
            const placeholder = document.getElementById('canvasPlaceholder');
            
            // Hide placeholder if it exists
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            let elementName = getElementName(type);
            let elementHTML = generateFormElementHTML(type, elementId);
            
            // Create a simpler element first that definitely works
            const element = document.createElement('div');
            element.className = 'border rounded p-3 mb-3 bg-white position-relative';
            element.setAttribute('data-type', type);
            element.setAttribute('data-id', elementId);
            element.style.marginLeft = '10px';
            element.style.marginRight = '10px';
            
            element.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold text-primary">${elementName}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="editElement('${elementId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeElement('${elementId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div>
                    ${elementHTML}
                </div>
            `;
            
            canvas.appendChild(element);
            currentFormElements.push({id: elementId, type: type, html: elementHTML, name: elementName});
            
            console.log('Element added to canvas:', elementId, type);
        }

        function addElementToPDF(type, elementId) {
            let elementHTML = generateFormElementHTML(type, elementId);
            
            const draggableElement = document.createElement('div');
            draggableElement.className = 'form-element-draggable';
            draggableElement.setAttribute('data-type', type);
            draggableElement.setAttribute('data-id', elementId);
            draggableElement.innerHTML = `
                <div class="element-controls">
                    <button class="btn btn-sm btn-outline-primary" onclick="editElement('${elementId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeElement('${elementId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                ${elementHTML}
            `;
            
            // Add to first PDF page by default
            if (pdfPages.length > 0) {
                pdfPages[0].element.appendChild(draggableElement);
                pdfPages[0].formElements.push({
                    id: elementId,
                    type: type,
                    position: { x: 50, y: 50 },
                    size: { width: 150, height: 40 }
                });
            }
        }

        function getElementName(type) {
            const names = {
                'text': 'Text Input',
                'textarea': 'Text Area', 
                'select': 'Dropdown',
                'checkbox': 'Checkboxes',
                'radio': 'Radio Buttons',
                'signature': 'Digital Signature',
                'initials': 'Initials',
                'signhere': 'Sign Here',
                'dateSigned': 'Date Signed',
                'name': 'Full Name',
                'email': 'Email Address',
                'company': 'Company',
                'title': 'Job Title',
                'date': 'Date Picker',
                'file': 'File Upload',
                'payment': 'Payment',
                'formula': 'Formula Field',
                'label': 'Label'
            };
            return names[type] || type.charAt(0).toUpperCase() + type.slice(1) + ' Field';
        }

        function generateFormElementHTML(type, elementId) {
            switch (type) {
                case 'text':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Text Input</label>
                            <input type="text" class="form-control" placeholder="Enter text..." disabled>
                        </div>
                    `;
                case 'textarea':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Text Area</label>
                            <textarea class="form-control" rows="3" placeholder="Enter text..." disabled></textarea>
                        </div>
                    `;
                case 'select':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Dropdown</label>
                            <select class="form-control" disabled>
                                <option>Option 1</option>
                                <option>Option 2</option>
                                <option>Option 3</option>
                            </select>
                        </div>
                    `;
                case 'checkbox':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Checkboxes</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" disabled>
                                <label class="form-check-label">Option 1</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" disabled>
                                <label class="form-check-label">Option 2</label>
                            </div>
                        </div>
                    `;
                case 'radio':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Radio Buttons</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radio${elementId}" disabled>
                                <label class="form-check-label">Option 1</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radio${elementId}" disabled>
                                <label class="form-check-label">Option 2</label>
                            </div>
                        </div>
                    `;
                case 'signature':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Digital Signature</label>
                            <div class="border rounded p-3 text-center signature-field" style="height: 120px; background: #f8f9fa;">
                                <i class="fas fa-signature fa-2x text-success mb-2"></i>
                                <p class="text-muted">Click to sign</p>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-secondary" disabled>Clear</button>
                                <button type="button" class="btn btn-sm btn-primary" disabled>Save</button>
                            </div>
                        </div>
                    `;
                case 'initials':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Initials</label>
                            <div class="border rounded p-3 text-center" style="height: 80px; background: #f8f9fa;">
                                <i class="fas fa-pen-fancy fa-lg text-success mb-1"></i>
                                <p class="text-muted small">Initial here</p>
                            </div>
                        </div>
                    `;
                case 'name':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" placeholder="Enter full name" disabled>
                        </div>
                    `;
                case 'email':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" placeholder="Enter email address" disabled>
                        </div>
                    `;
                case 'date':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" disabled>
                        </div>
                    `;
                case 'payment':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Payment</label>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="number" class="form-control" placeholder="0.00" step="0.01" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-control" disabled>
                                                <option>USD</option>
                                                <option>EUR</option>
                                                <option>GBP</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <i class="fas fa-credit-card me-2"></i>Payment Processing
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                case 'file':
                    return `
                        <div class="mb-3">
                            <label class="form-label">File Upload</label>
                            <input type="file" class="form-control" disabled>
                            <small class="text-muted">Upload a file (PDF, DOC, JPG, PNG)</small>
                        </div>
                    `;
                case 'company':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" placeholder="Enter company name" disabled>
                        </div>
                    `;
                case 'title':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-control" placeholder="Enter job title" disabled>
                        </div>
                    `;
                case 'dateSigned':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Date Signed</label>
                            <input type="text" class="form-control" value="${new Date().toLocaleDateString()}" disabled>
                        </div>
                    `;
                case 'signhere':
                    return `
                        <div class="mb-3">
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-hand-point-right me-2"></i>
                                <strong>Sign Here</strong>
                            </div>
                        </div>
                    `;
                case 'formula':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Formula Field</label>
                            <input type="text" class="form-control" placeholder="Calculated value" disabled>
                            <small class="text-muted">Formula: SUM(field1, field2)</small>
                        </div>
                    `;
                case 'label':
                    return `
                        <div class="mb-3">
                            <h6 class="fw-bold">Text Label</h6>
                            <p class="text-muted">This is a label or instruction text that appears in your form.</p>
                        </div>
                    `;
                default:
                    return `
                        <div class="mb-3">
                            <label class="form-label">${type.charAt(0).toUpperCase() + type.slice(1)} Field</label>
                            <input type="text" class="form-control" placeholder="${type}" disabled>
                        </div>
                    `;
            }
        }

        // PDF Zoom Controls
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.2, 3.0);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.2, 0.5);
            updateZoom();
        }

        function updateZoom() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            const pagesContainer = document.getElementById('pdfPages');
            pagesContainer.style.transform = `scale(${currentZoom})`;
            pagesContainer.style.transformOrigin = 'top center';
        }

        // Payment Gateway Integration

        // Stripe Integration
        let stripeInstance = null;

        async function initializeStripe() {
            const publishableKey = document.getElementById('stripePublishableKey').value;
            if (!publishableKey) {
                alert('Please enter Stripe publishable key');
                return false;
            }

            try {
                stripeInstance = Stripe(publishableKey);
                return true;
            } catch (error) {
                console.error('Stripe initialization error:', error);
                alert('Invalid Stripe key');
                return false;
            }
        }

        async function testStripeConnection() {
            if (await initializeStripe()) {
                alert('Stripe connection successful!');
                localStorage.setItem('stripe_publishable_key', document.getElementById('stripePublishableKey').value);
                localStorage.setItem('stripe_secret_key', document.getElementById('stripeSecretKey').value);
            }
        }

        async function processStripePayment(amount, currency = 'usd') {
            if (!stripeInstance && !(await initializeStripe())) {
                throw new Error('Stripe not initialized');
            }

            const { error, paymentMethod } = await stripeInstance.createPaymentMethod({
                type: 'card',
                card: {
                    // Card element would be created here in real implementation
                }
            });

            if (error) {
                throw error;
            }

            // In real implementation, send to server to create payment intent
            const response = await fetch('/api/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: amount * 100, // Convert to cents
                    currency: currency,
                    payment_method: paymentMethod.id
                })
            });

            return await response.json();
        }

        // PayPal Integration
        async function initializePayPal() {
            const clientId = document.getElementById('paypalClientId').value;
            if (!clientId) {
                alert('Please enter PayPal client ID');
                return false;
            }

            try {
                // PayPal SDK would be loaded with the client ID
                return true;
            } catch (error) {
                console.error('PayPal initialization error:', error);
                return false;
            }
        }

        async function testPayPalConnection() {
            if (await initializePayPal()) {
                alert('PayPal connection successful!');
                localStorage.setItem('paypal_client_id', document.getElementById('paypalClientId').value);
                localStorage.setItem('paypal_client_secret', document.getElementById('paypalClientSecret').value);
            }
        }

        function createPayPalOrder(amount, currency = 'USD') {
            return paypal.Orders.create({
                intent: 'CAPTURE',
                purchase_units: [{
                    amount: {
                        currency_code: currency,
                        value: amount.toString()
                    }
                }]
            });
        }

        function capturePayPalOrder(orderID) {
            return paypal.Orders.capture(orderID);
        }

        // SendGrid Email Integration
        async function testSendGridConnection() {
            const apiKey = document.getElementById('sendgridApiKey').value;
            const fromEmail = document.getElementById('sendgridFromEmail').value;
            
            if (!apiKey || !fromEmail) {
                alert('Please enter SendGrid API key and from email');
                return;
            }

            try {
                const testEmailData = {
                    to: fromEmail, // Send test to self
                    from: fromEmail,
                    subject: 'FormBuilder Pro - Test Email',
                    html: `
                        <h2>SendGrid Integration Test</h2>
                        <p>This is a test email from FormBuilder Pro.</p>
                        <p>If you receive this email, your SendGrid integration is working correctly!</p>
                        <p>Sent at: ${new Date().toLocaleString()}</p>
                    `
                };

                await sendEmail(testEmailData);
                alert('Test email sent successfully! Check your inbox.');
                
                localStorage.setItem('sendgrid_api_key', apiKey);
                localStorage.setItem('sendgrid_from_email', fromEmail);
                localStorage.setItem('sendgrid_from_name', document.getElementById('sendgridFromName').value);
                
            } catch (error) {
                console.error('SendGrid test error:', error);
                alert('SendGrid test failed. Please check your API key and email settings.');
            }
        }

        async function sendEmail(emailData) {
            const apiKey = document.getElementById('sendgridApiKey').value || localStorage.getItem('sendgrid_api_key');
            
            if (!apiKey) {
                throw new Error('SendGrid API key not configured');
            }

            // In real implementation, this would go through your backend
            const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    personalizations: [{
                        to: [{ email: emailData.to }],
                        subject: emailData.subject
                    }],
                    from: { 
                        email: emailData.from,
                        name: document.getElementById('sendgridFromName').value 
                    },
                    content: [{
                        type: 'text/html',
                        value: emailData.html
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`SendGrid API error: ${response.status}`);
            }

            return response;
        }

        // Enhanced Document Sending with Email Notifications
        async function sendDocumentWithNotification(documentId, recipients, message) {
            try {
                // Send document for signatures
                const sentDocument = await sendDocument(documentId, recipients, message);
                
                // Send email notifications to all recipients
                for (const recipient of recipients) {
                    const emailTemplate = getEmailTemplate('document_ready', {
                        recipientName: recipient.name,
                        documentTitle: sentDocument.title,
                        signingUrl: `${window.location.origin}/sign/${sentDocument.id}`,
                        message: message
                    });

                    await sendEmail({
                        to: recipient.email,
                        from: document.getElementById('sendgridFromEmail').value,
                        subject: `Please sign: ${sentDocument.title}`,
                        html: emailTemplate
                    });
                }

                return sentDocument;
            } catch (error) {
                console.error('Error sending document with notifications:', error);
                throw error;
            }
        }

        function getEmailTemplate(templateType, data) {
            const templates = {
                document_ready: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #2563eb;">Document Ready for Signature</h2>
                        <p>Hello ${data.recipientName},</p>
                        <p>You have been requested to sign the following document:</p>
                        <h3>${data.documentTitle}</h3>
                        ${data.message ? `<p><em>"${data.message}"</em></p>` : ''}
                        <a href="${data.signingUrl}" style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 20px 0;">
                            Review & Sign Document
                        </a>
                        <p>If you have any questions, please contact the sender.</p>
                        <p>Best regards,<br>FormBuilder Pro</p>
                    </div>
                `,
                document_completed: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #10b981;">Document Completed</h2>
                        <p>Hello ${data.recipientName},</p>
                        <p>The document "${data.documentTitle}" has been successfully completed by all parties.</p>
                        <p>You can download the completed document using the link below:</p>
                        <a href="${data.downloadUrl}" style="background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 20px 0;">
                            Download Completed Document
                        </a>
                        <p>Thank you for using FormBuilder Pro.</p>
                    </div>
                `,
                payment_received: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #10b981;">Payment Received</h2>
                        <p>Hello ${data.recipientName},</p>
                        <p>We have successfully received your payment for "${data.documentTitle}".</p>
                        <p><strong>Payment Details:</strong></p>
                        <ul>
                            <li>Amount: ${data.amount}</li>
                            <li>Transaction ID: ${data.transactionId}</li>
                            <li>Date: ${data.paymentDate}</li>
                        </ul>
                        <p>Thank you for your payment.</p>
                    </div>
                `
            };

            return templates[templateType] || templates.document_ready;
        }

        // Load saved configuration on page load
        function loadSavedConfiguration() {
            const stripeKey = localStorage.getItem('stripe_publishable_key');
            const paypalClientId = localStorage.getItem('paypal_client_id');
            const sendgridKey = localStorage.getItem('sendgrid_api_key');
            const sendgridEmail = localStorage.getItem('sendgrid_from_email');
            const sendgridName = localStorage.getItem('sendgrid_from_name');

            if (stripeKey) {
                document.getElementById('stripePublishableKey').value = stripeKey;
                document.getElementById('stripeEnabled').checked = true;
            }
            if (paypalClientId) {
                document.getElementById('paypalClientId').value = paypalClientId;
                document.getElementById('paypalEnabled').checked = true;
            }
            if (sendgridKey) {
                document.getElementById('sendgridApiKey').value = sendgridKey;
                document.getElementById('sendgridEnabled').checked = true;
            }
            if (sendgridEmail) {
                document.getElementById('sendgridFromEmail').value = sendgridEmail;
            }
            if (sendgridName) {
                document.getElementById('sendgridFromName').value = sendgridName;
            }
        }

        // Initialize drag and drop for PDF upload
        function initializePDFUpload() {
            const uploadZone = document.getElementById('pdfUploadZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadZone.classList.add('dragover');
            }

            function unhighlight(e) {
                uploadZone.classList.remove('dragover');
            }

            uploadZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        document.getElementById('pdfFileInput').files = files;
                        handlePDFUpload({ target: { files: [file] } });
                    } else {
                        alert('Please upload a PDF file');
                    }
                }
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Starting FormBuilder Pro initialization...');
            
            // Show loading state
            showLoadingState('Initializing libraries...');
            
            try {
                // Wait for all critical libraries to load
                const librariesLoaded = await window.librariesReady;
                if (!librariesLoaded) {
                    throw new Error('Failed to load required libraries');
                }
                
                console.log('üìö All libraries loaded, initializing application...');
                showLoadingState('Loading configuration...');
                
                // Initialize application components
                loadSavedConfiguration();
                initializePDFUpload();
                initializeBuiltInTemplates();
                
                // Hide loading state
                hideLoadingState();
                
                console.log('‚úÖ FormBuilder Pro initialized successfully');
                
            } catch (error) {
                console.error('üí• Initialization failed:', error);
                showErrorState('Failed to initialize application. Please refresh the page.');
            }
        });
        
        function showLoadingState(message) {
            // Create or update loading overlay
            let overlay = document.getElementById('loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 255, 255, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    font-family: 'Inter', sans-serif;
                `;
                document.body.appendChild(overlay);
            }
            
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-primary">${message}</h5>
                    <p class="text-muted">Please wait while we prepare your workspace...</p>
                </div>
            `;
        }
        
        function hideLoadingState() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function showErrorState(message) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-danger mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-danger">Initialization Error</h5>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-primary" onclick="window.location.reload()">
                            <i class="fas fa-refresh me-2"></i>Refresh Page
                        </button>
                    </div>
                `;
            }
        }

        // Built-in Template System
        function initializeBuiltInTemplates() {
            const builtInTemplates = [
                {
                    id: 'contract_template_001',
                    title: 'Service Agreement Contract',
                    category: 'Contracts',
                    description: 'Professional service agreement with payment terms, scope of work, and digital signatures.',
                    fields: [
                        { type: 'text', label: 'Client Company Name', required: true },
                        { type: 'text', label: 'Service Provider Name', required: true },
                        { type: 'date', label: 'Contract Start Date', required: true },
                        { type: 'date', label: 'Contract End Date', required: true },
                        { type: 'textarea', label: 'Scope of Work Description', required: true },
                        { type: 'text', label: 'Total Contract Value ($)', required: true },
                        { type: 'select', label: 'Payment Terms', options: ['Net 30', 'Net 15', 'Upon Completion', 'Monthly'], required: true },
                        { type: 'signature', label: 'Client Signature', required: true },
                        { type: 'signature', label: 'Service Provider Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'nda_template_001',
                    title: 'Non-Disclosure Agreement (NDA)',
                    category: 'Legal',
                    description: 'Standard NDA for protecting confidential information between parties.',
                    fields: [
                        { type: 'text', label: 'Disclosing Party Name', required: true },
                        { type: 'text', label: 'Receiving Party Name', required: true },
                        { type: 'text', label: 'Disclosing Party Title', required: true },
                        { type: 'text', label: 'Receiving Party Title', required: true },
                        { type: 'date', label: 'Effective Date', required: true },
                        { type: 'select', label: 'Agreement Duration', options: ['1 Year', '2 Years', '3 Years', '5 Years', 'Indefinite'], required: true },
                        { type: 'textarea', label: 'Purpose of Disclosure', required: true },
                        { type: 'checkbox', label: 'Return of Materials Required', required: false },
                        { type: 'signature', label: 'Disclosing Party Signature', required: true },
                        { type: 'signature', label: 'Receiving Party Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'employment_template_001',
                    title: 'Employment Application Form',
                    category: 'HR & Employment',
                    description: 'Comprehensive employment application with personal information, work history, and references.',
                    fields: [
                        { type: 'text', label: 'Full Name', required: true },
                        { type: 'email', label: 'Email Address', required: true },
                        { type: 'text', label: 'Phone Number', required: true },
                        { type: 'textarea', label: 'Current Address', required: true },
                        { type: 'text', label: 'Position Applied For', required: true },
                        { type: 'date', label: 'Available Start Date', required: true },
                        { type: 'select', label: 'Employment Type Desired', options: ['Full-time', 'Part-time', 'Contract', 'Temporary'], required: true },
                        { type: 'text', label: 'Desired Salary', required: false },
                        { type: 'textarea', label: 'Previous Work Experience', required: true },
                        { type: 'textarea', label: 'Education Background', required: true },
                        { type: 'textarea', label: 'Skills and Qualifications', required: true },
                        { type: 'text', label: 'Reference 1 Name & Contact', required: true },
                        { type: 'text', label: 'Reference 2 Name & Contact', required: true },
                        { type: 'checkbox', label: 'I authorize background check', required: true },
                        { type: 'signature', label: 'Applicant Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'invoice_template_001',
                    title: 'Professional Invoice Form',
                    category: 'Finance',
                    description: 'Professional invoice template with payment processing integration.',
                    fields: [
                        { type: 'text', label: 'Invoice Number', required: true },
                        { type: 'date', label: 'Invoice Date', required: true },
                        { type: 'date', label: 'Due Date', required: true },
                        { type: 'text', label: 'Bill To: Company Name', required: true },
                        { type: 'textarea', label: 'Bill To: Address', required: true },
                        { type: 'text', label: 'From: Your Company Name', required: true },
                        { type: 'textarea', label: 'From: Your Address', required: true },
                        { type: 'textarea', label: 'Description of Services/Products', required: true },
                        { type: 'text', label: 'Quantity', required: true },
                        { type: 'text', label: 'Rate ($)', required: true },
                        { type: 'text', label: 'Subtotal ($)', required: true },
                        { type: 'text', label: 'Tax Rate (%)', required: false },
                        { type: 'text', label: 'Tax Amount ($)', required: false },
                        { type: 'text', label: 'Total Amount ($)', required: true },
                        { type: 'textarea', label: 'Payment Terms', required: true },
                        { type: 'payment', label: 'Payment Processing', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'lease_template_001',
                    title: 'Residential Lease Agreement',
                    category: 'Real Estate',
                    description: 'Standard residential lease agreement with all necessary terms and conditions.',
                    fields: [
                        { type: 'text', label: 'Landlord Name', required: true },
                        { type: 'text', label: 'Tenant Name(s)', required: true },
                        { type: 'textarea', label: 'Property Address', required: true },
                        { type: 'date', label: 'Lease Start Date', required: true },
                        { type: 'date', label: 'Lease End Date', required: true },
                        { type: 'text', label: 'Monthly Rent Amount ($)', required: true },
                        { type: 'text', label: 'Security Deposit ($)', required: true },
                        { type: 'select', label: 'Rent Due Date', options: ['1st of month', '15th of month', 'Last day of month'], required: true },
                        { type: 'checkbox', label: 'Pets Allowed', required: false },
                        { type: 'text', label: 'Pet Deposit ($)', required: false },
                        { type: 'textarea', label: 'Special Terms and Conditions', required: false },
                        { type: 'checkbox', label: 'Tenant has read and agrees to all terms', required: true },
                        { type: 'signature', label: 'Landlord Signature', required: true },
                        { type: 'signature', label: 'Tenant Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'medical_template_001',
                    title: 'Patient Intake Form',
                    category: 'Healthcare',
                    description: 'Comprehensive patient intake form for medical practices.',
                    fields: [
                        { type: 'text', label: 'Patient Full Name', required: true },
                        { type: 'date', label: 'Date of Birth', required: true },
                        { type: 'select', label: 'Gender', options: ['Male', 'Female', 'Other', 'Prefer not to say'], required: true },
                        { type: 'text', label: 'Phone Number', required: true },
                        { type: 'email', label: 'Email Address', required: true },
                        { type: 'textarea', label: 'Current Address', required: true },
                        { type: 'text', label: 'Emergency Contact Name', required: true },
                        { type: 'text', label: 'Emergency Contact Phone', required: true },
                        { type: 'text', label: 'Insurance Provider', required: true },
                        { type: 'text', label: 'Policy Number', required: true },
                        { type: 'textarea', label: 'Current Medications', required: false },
                        { type: 'textarea', label: 'Known Allergies', required: false },
                        { type: 'textarea', label: 'Medical History', required: false },
                        { type: 'textarea', label: 'Reason for Visit', required: true },
                        { type: 'checkbox', label: 'I authorize treatment', required: true },
                        { type: 'checkbox', label: 'I authorize insurance billing', required: true },
                        { type: 'signature', label: 'Patient Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'event_template_001',
                    title: 'Event Registration Form',
                    category: 'Events',
                    description: 'Event registration form with payment processing for conferences, workshops, and events.',
                    fields: [
                        { type: 'text', label: 'Full Name', required: true },
                        { type: 'email', label: 'Email Address', required: true },
                        { type: 'text', label: 'Phone Number', required: true },
                        { type: 'text', label: 'Company/Organization', required: false },
                        { type: 'text', label: 'Job Title', required: false },
                        { type: 'select', label: 'Registration Type', options: ['Early Bird', 'Regular', 'Student', 'VIP'], required: true },
                        { type: 'checkbox', label: 'Dietary Restrictions', required: false },
                        { type: 'textarea', label: 'Special Dietary Needs', required: false },
                        { type: 'select', label: 'T-Shirt Size', options: ['XS', 'S', 'M', 'L', 'XL', 'XXL'], required: false },
                        { type: 'checkbox', label: 'I agree to photography/videography', required: false },
                        { type: 'checkbox', label: 'Subscribe to newsletter', required: false },
                        { type: 'textarea', label: 'How did you hear about this event?', required: false },
                        { type: 'text', label: 'Registration Fee ($)', required: true },
                        { type: 'payment', label: 'Payment Processing', required: true },
                        { type: 'signature', label: 'Participant Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                },
                {
                    id: 'vendor_template_001',
                    title: 'Vendor Application Form',
                    category: 'Business',
                    description: 'Vendor application and agreement form for suppliers and service providers.',
                    fields: [
                        { type: 'text', label: 'Company Name', required: true },
                        { type: 'text', label: 'Contact Person Name', required: true },
                        { type: 'text', label: 'Contact Person Title', required: true },
                        { type: 'email', label: 'Email Address', required: true },
                        { type: 'text', label: 'Phone Number', required: true },
                        { type: 'textarea', label: 'Business Address', required: true },
                        { type: 'text', label: 'Tax ID/EIN Number', required: true },
                        { type: 'text', label: 'Years in Business', required: true },
                        { type: 'textarea', label: 'Products/Services Offered', required: true },
                        { type: 'text', label: 'Annual Revenue', required: false },
                        { type: 'textarea', label: 'Key Customers/References', required: true },
                        { type: 'text', label: 'Insurance Provider', required: true },
                        { type: 'text', label: 'Insurance Policy Number', required: true },
                        { type: 'checkbox', label: 'Minority/Woman-owned Business', required: false },
                        { type: 'checkbox', label: 'I agree to vendor terms and conditions', required: true },
                        { type: 'signature', label: 'Authorized Signature', required: true },
                        { type: 'dateSigned', label: 'Date Signed', required: true }
                    ],
                    isTemplate: true,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                }
            ];

            // Store built-in templates in localStorage
            const existingTemplates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const allTemplates = [...existingTemplates];

            // Add built-in templates if they don't exist
            builtInTemplates.forEach(template => {
                if (!allTemplates.find(t => t.id === template.id)) {
                    allTemplates.push(template);
                }
            });

            localStorage.setItem('formbuilder_templates', JSON.stringify(allTemplates));
        }

        // Enhanced template loading with categories
        function loadTemplatesList() {
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const templatesList = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                templatesList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-copy fa-3x mb-3"></i>
                        <p>No templates available</p>
                    </div>
                `;
                return;
            }

            // Group templates by category
            const categories = {};
            templates.forEach(template => {
                const category = template.category || 'General';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(template);
            });

            templatesList.innerHTML = '';

            // Create category sections
            Object.keys(categories).forEach(categoryName => {
                const categorySection = document.createElement('div');
                categorySection.className = 'mb-4';
                categorySection.innerHTML = `
                    <h6 class="text-primary fw-bold mb-3">
                        <i class="fas fa-folder me-2"></i>${categoryName}
                    </h6>
                `;

                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'row';

                categories[categoryName].forEach(template => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'col-md-6 mb-3';
                    templateCard.innerHTML = `
                        <div class="card h-100 template-card" style="cursor: pointer; transition: all 0.2s ease;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${template.title}</h6>
                                    <span class="badge bg-info">${template.fields.length} fields</span>
                                </div>
                                <p class="card-text text-muted small mb-3">${template.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Used ${template.usageCount || 0} times</small>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="useTemplate('${template.id}')">
                                            <i class="fas fa-plus me-1"></i>Use
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="previewTemplate('${template.id}')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add hover effects
                    const card = templateCard.querySelector('.template-card');
                    card.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                    });
                    card.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '';
                    });

                    categoryGrid.appendChild(templateCard);
                });

                categorySection.appendChild(categoryGrid);
                templatesList.appendChild(categorySection);
            });
        }

        // Use template function
        function useTemplate(templateId) {
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const template = templates.find(t => t.id === templateId);
            
            if (!template) {
                alert('Template not found');
                return;
            }

            // Update usage count
            template.usageCount = (template.usageCount || 0) + 1;
            localStorage.setItem('formbuilder_templates', JSON.stringify(templates));

            // Clear current form
            currentFormElements = [];
            const canvas = document.getElementById('formCanvas');
            canvas.innerHTML = '';
            const placeholder = document.getElementById('canvasPlaceholder');
            if (placeholder) placeholder.style.display = 'none';

            // Set form title
            document.getElementById('formTitle').value = template.title + ' - Copy';

            // Add template fields to canvas
            template.fields.forEach((field, index) => {
                setTimeout(() => {
                    addElementToCanvas(field.type, 'template_' + templateId + '_' + index);
                }, index * 100); // Stagger the additions for visual effect
            });

            // Switch to create form section
            showSection('create-form');
            
            // Show success message
            setTimeout(() => {
                alert(`Template "${template.title}" loaded successfully! You can now customize the fields.`);
            }, template.fields.length * 100 + 500);
        }

        // Preview template function
        function previewTemplate(templateId) {
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const template = templates.find(t => t.id === templateId);
            
            if (!template) {
                alert('Template not found');
                return;
            }

            // Create preview modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${template.title} - Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-3">${template.description}</p>
                            <h6>Fields included in this template:</h6>
                            <div class="row">
                                ${template.fields.map(field => `
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-${getFieldIcon(field.type)} me-2 text-primary"></i>
                                            <span>${field.label}</span>
                                            ${field.required ? '<span class="badge bg-danger ms-2">Required</span>' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="useTemplate('${templateId}'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">
                                <i class="fas fa-plus me-2"></i>Use This Template
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Remove modal from DOM when hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        function getFieldIcon(type) {
            const icons = {
                'text': 'font',
                'textarea': 'align-left',
                'email': 'envelope',
                'date': 'calendar',
                'select': 'list',
                'checkbox': 'check-square',
                'radio': 'dot-circle',
                'signature': 'signature',
                'payment': 'credit-card',
                'file': 'file-upload'
            };
            return icons[type] || 'form';
        }

        // Helper functions for missing functionality
        function editElement(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (element) {
                element.classList.toggle('selected');
                // Show property panel for element editing
                const type = element.getAttribute('data-type');
                showElementPropertyPanel(elementId, type);
            }
        }

        function showElementPropertyPanel(elementId, type) {
            // This would show a property panel for editing element properties
            // For now, just show a simple prompt
            const newLabel = prompt(`Edit ${type} element label:`, `${type} field`);
            if (newLabel) {
                const labelElement = document.querySelector(`[data-id="${elementId}"] label`);
                if (labelElement) {
                    labelElement.textContent = newLabel;
                }
            }
        }

        function addRecipient() {
            const recipientsList = document.getElementById('recipientsList');
            const recipientItem = document.createElement('div');
            recipientItem.className = 'recipient-item mb-3 p-3 border rounded';
            recipientItem.innerHTML = `
                <div class="mb-2">
                    <input type="email" class="form-control form-control-sm" placeholder="Email address" name="recipientEmail">
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Full name" name="recipientName">
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <select class="form-control form-control-sm" name="recipientRole">
                        <option value="signer">Signer</option>
                        <option value="cc">CC</option>
                        <option value="viewer">Viewer</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            recipientsList.appendChild(recipientItem);
        }

        function sendDocument() {
            const documentSelect = document.getElementById('documentSelect').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (!documentSelect) {
                alert('Please select a document');
                return;
            }

            const recipients = [];
            const recipientItems = document.querySelectorAll('.recipient-item');
            
            recipientItems.forEach(item => {
                const email = item.querySelector('input[name="recipientEmail"]').value;
                const name = item.querySelector('input[name="recipientName"]').value;
                const role = item.querySelector('select[name="recipientRole"]').value;
                
                if (email) {
                    recipients.push({ email, name: name || email, role });
                }
            });

            if (recipients.length === 0) {
                alert('Please add at least one recipient');
                return;
            }

            // Send document with email notifications if SendGrid is configured
            if (document.getElementById('sendgridEnabled').checked) {
                sendDocumentWithNotification(documentSelect, recipients, message)
                    .then(() => {
                        alert('Document sent successfully with email notifications!');
                        showSection('tracking');
                    })
                    .catch(error => {
                        console.error('Error sending document:', error);
                        alert('Error sending document. Please check your email configuration.');
                    });
            } else {
                // Fallback to basic document sending
                alert('Document sent successfully! Enable SendGrid for automatic email notifications.');
                showSection('tracking');
            }
        }

        // Compliance functions
        function generateComplianceReport() {
            const forms = TemplateAuth.getUserForms();
            const completedForms = forms.filter(f => f.status === 'completed');
            
            if (completedForms.length === 0) {
                alert('No completed documents to generate report for');
                return;
            }
            
            let reportData = 'Document Title,Completed Date,Signers,Certificate ID\n';
            
            completedForms.forEach(form => {
                const certificate = TemplateAuth.generateCertificate(form.id);
                if (certificate) {
                    const signers = certificate.signers.map(s => s.name).join('; ');
                    reportData += `"${form.title}","${new Date(form.completedAt).toLocaleDateString()}","${signers}","${certificate.certificateId}"\n`;
                }
            });
            
            // Download as CSV
            const blob = new Blob([reportData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compliance-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Compliance report downloaded successfully!');
        }

        // Update showSection to handle new sections
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);
            
            // Load data for specific sections
            if (sectionName === 'templates') {
                loadTemplatesList();
                loadDocumentSelect(); // Update bulk send template list too
            } else if (sectionName === 'bulk-send') {
                loadBulkSendTemplates();
            } else if (sectionName === 'analytics') {
                loadAdvancedAnalytics();
            }
        };

        function loadBulkSendTemplates() {
            const forms = TemplateAuth.getUserForms();
            const templates = forms.filter(form => form.isTemplate);
            const bulkTemplate = document.getElementById('bulkTemplate');
            
            bulkTemplate.innerHTML = '<option value="">Choose a template...</option>';
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.title;
                bulkTemplate.appendChild(option);
            });
        }

        // CSV file change handler for bulk send
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Setup bulk send file handler
            const recipientsFile = document.getElementById('recipientsFile');
            if (recipientsFile) {
                recipientsFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const csv = event.target.result;
                            const lines = csv.split('\n');
                            const recipientCount = Math.max(0, lines.length - 1); // Exclude header
                            
                            document.getElementById('bulkRecipientCount').textContent = recipientCount;
                            document.getElementById('bulkEstimatedCost').textContent = '$' + (recipientCount * 0.50).toFixed(2);
                            document.getElementById('bulkProcessingTime').textContent = '~' + Math.ceil(recipientCount / 10) + ' min';
                        };
                        reader.readAsText(file);
                    }
                });
            }
        });

        // Additional template functions
        function createNewTemplate() {
            const title = prompt('Enter template name:');
            if (title) {
                // Clear current form and start fresh
                currentFormElements = [];
                const canvas = document.getElementById('formCanvas');
                canvas.innerHTML = '';
                document.getElementById('formTitle').value = title;
                showSection('create-form');
                
                // Add a note that this will be saved as a template
                const alert = document.createElement('div');
                alert.className = 'alert alert-info alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Template Mode:</strong> This form will be saved as a reusable template.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                canvas.parentElement.insertBefore(alert, canvas);
            }
        }

        function showTemplateGallery() {
            // Create a gallery modal showing all templates
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-images me-2"></i>Template Gallery
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-handshake fa-3x text-primary mb-3"></i>
                                            <h6>Service Agreement</h6>
                                            <p class="small text-muted">Professional service contract with payment terms</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('contract_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                                            <h6>Non-Disclosure Agreement</h6>
                                            <p class="small text-muted">Protect confidential information</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('nda_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-tie fa-3x text-info mb-3"></i>
                                            <h6>Employment Application</h6>
                                            <p class="small text-muted">Comprehensive job application form</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('employment_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-invoice-dollar fa-3x text-warning mb-3"></i>
                                            <h6>Professional Invoice</h6>
                                            <p class="small text-muted">Invoice with payment processing</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('invoice_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-home fa-3x text-danger mb-3"></i>
                                            <h6>Lease Agreement</h6>
                                            <p class="small text-muted">Residential lease contract</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('lease_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-heartbeat fa-3x text-success mb-3"></i>
                                            <h6>Patient Intake Form</h6>
                                            <p class="small text-muted">Medical practice intake form</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('medical_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
                                            <h6>Event Registration</h6>
                                            <p class="small text-muted">Event signup with payment</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('event_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-truck fa-3x text-info mb-3"></i>
                                            <h6>Vendor Application</h6>
                                            <p class="small text-muted">Supplier application form</p>
                                            <button class="btn btn-sm btn-primary" onclick="useTemplate('vendor_template_001'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        function refreshTemplates() {
            // Refresh template statistics and list
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const builtInTemplates = templates.filter(t => t.isTemplate);
            const customTemplates = templates.filter(t => !t.isTemplate);
            const usedTemplates = templates.filter(t => (t.usageCount || 0) > 0);

            document.getElementById('totalTemplates').textContent = templates.length;
            document.getElementById('usedTemplates').textContent = usedTemplates.length;
            document.getElementById('customTemplates').textContent = customTemplates.length;
            
            // Reload templates list
            loadTemplatesList();
        }

        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const templateData = JSON.parse(event.target.result);
                            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
                            
                            // Add unique ID if not present
                            if (!templateData.id) {
                                templateData.id = 'imported_' + Date.now();
                            }
                            
                            templates.push(templateData);
                            localStorage.setItem('formbuilder_templates', JSON.stringify(templates));
                            
                            alert('Template imported successfully!');
                            refreshTemplates();
                        } catch (error) {
                            alert('Error importing template. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportTemplates() {
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const customTemplates = templates.filter(t => !t.isTemplate);
            
            if (customTemplates.length === 0) {
                alert('No custom templates to export');
                return;
            }
            
            const dataStr = JSON.stringify(customTemplates, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `formbuilder-templates-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Templates exported successfully!');
        }

        // Enhanced loadTemplatesList with filtering
        const originalLoadTemplatesList = loadTemplatesList;
        loadTemplatesList = function() {
            const showOnlyCustom = document.getElementById('showOnlyCustom')?.checked || false;
            const templates = JSON.parse(localStorage.getItem('formbuilder_templates') || '[]');
            const templatesList = document.getElementById('templatesList');
            
            let filteredTemplates = templates;
            if (showOnlyCustom) {
                filteredTemplates = templates.filter(t => !t.isTemplate);
            }
            
            if (filteredTemplates.length === 0) {
                templatesList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-copy fa-3x mb-3"></i>
                        <p>${showOnlyCustom ? 'No custom templates created yet' : 'No templates available'}</p>
                        ${showOnlyCustom ? '<button class="btn btn-primary" onclick="createNewTemplate()">Create Your First Template</button>' : ''}
                    </div>
                `;
                return;
            }

            // Group templates by category
            const categories = {};
            filteredTemplates.forEach(template => {
                const category = template.category || 'General';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(template);
            });

            templatesList.innerHTML = '';

            // Create category sections
            Object.keys(categories).forEach(categoryName => {
                const categorySection = document.createElement('div');
                categorySection.className = 'mb-4';
                categorySection.innerHTML = `
                    <h6 class="text-primary fw-bold mb-3">
                        <i class="fas fa-folder me-2"></i>${categoryName}
                        <span class="badge bg-primary ms-2">${categories[categoryName].length}</span>
                    </h6>
                `;

                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'row';

                categories[categoryName].forEach(template => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'col-md-6 col-lg-4 col-xl-3 mb-3';
                    templateCard.innerHTML = `
                        <div class="card h-100 template-card" style="cursor: pointer; transition: all 0.2s ease;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${template.title}</h6>
                                    <div>
                                        <span class="badge bg-info">${template.fields.length} fields</span>
                                        ${template.isTemplate ? '<span class="badge bg-success ms-1">Built-in</span>' : '<span class="badge bg-warning ms-1">Custom</span>'}
                                    </div>
                                </div>
                                <p class="card-text text-muted small mb-3">${template.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-chart-line me-1"></i>Used ${template.usageCount || 0} times
                                    </small>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="useTemplate('${template.id}')">
                                            <i class="fas fa-plus me-1"></i>Use
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="previewTemplate('${template.id}')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add hover effects
                    const card = templateCard.querySelector('.template-card');
                    card.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                    });
                    card.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '';
                    });

                    categoryGrid.appendChild(templateCard);
                });

                categorySection.appendChild(categoryGrid);
                templatesList.appendChild(categorySection);
            });
        };

        // Add filter toggle handler
        document.addEventListener('DOMContentLoaded', function() {
            const showOnlyCustom = document.getElementById('showOnlyCustom');
            if (showOnlyCustom) {
                showOnlyCustom.addEventListener('change', loadTemplatesList);
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
</body>
</html>
